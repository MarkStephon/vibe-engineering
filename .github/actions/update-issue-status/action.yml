name: 'Update Issue Status'
description: 'ç»Ÿä¸€æ›´æ–° Issue çŠ¶æ€æ ‡ç­¾ï¼ˆprocessing/completed/failed/staleï¼‰'

inputs:
  issue_number:
    description: 'Issue ç¼–å·'
    required: true
  status:
    description: 'çŠ¶æ€ï¼šprocessing, completed, failed, stale'
    required: true
  github_token:
    description: 'GitHub Token'
    required: true
  add_comment:
    description: 'æ˜¯å¦æ·»åŠ çŠ¶æ€è¯„è®º'
    required: false
    default: 'false'
  comment_body:
    description: 'è¯„è®ºå†…å®¹ï¼ˆä»…å½“ add_comment=true æ—¶ä½¿ç”¨ï¼‰'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Update Issue Status Labels
      uses: actions/github-script@v7
      env:
        ISSUE_NUMBER: ${{ inputs.issue_number }}
        STATUS: ${{ inputs.status }}
        ADD_COMMENT: ${{ inputs.add_comment }}
        COMMENT_BODY: ${{ inputs.comment_body }}
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const issueNumber = parseInt(process.env.ISSUE_NUMBER);
          const status = process.env.STATUS;
          const addComment = process.env.ADD_COMMENT === 'true';
          const commentBody = process.env.COMMENT_BODY;

          // æ ‡ç­¾æ˜ å°„ - ä¸ workflow-config.json ä¿æŒä¸€è‡´
          const statusLabels = {
            processing: 'ğŸ¤– ai-processing',
            completed: 'âœ… ai-completed',
            failed: 'âŒ ai-failed',
            stale: 'âš ï¸ stale',
            deployed: 'âœ… deployed',
            needs_review: 'needs-review'
          };

          // æ‰€æœ‰çŠ¶æ€æ ‡ç­¾åˆ—è¡¨ï¼ˆç”¨äºæ¸…ç†ï¼‰
          const allStatusLabels = Object.values(statusLabels);

          const targetLabel = statusLabels[status];
          if (!targetLabel) {
            core.setFailed(`æ— æ•ˆçš„çŠ¶æ€: ${status}ã€‚æœ‰æ•ˆå€¼: ${Object.keys(statusLabels).join(', ')}`);
            return;
          }

          console.log(`ğŸ“ æ›´æ–° Issue #${issueNumber} çŠ¶æ€ä¸º: ${status} (${targetLabel})`);

          // è·å–å½“å‰æ ‡ç­¾
          const { data: issue } = await github.rest.issues.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber
          });

          const currentLabels = issue.labels.map(l => l.name);

          // ç§»é™¤å…¶ä»–çŠ¶æ€æ ‡ç­¾
          for (const label of allStatusLabels) {
            if (currentLabels.includes(label) && label !== targetLabel) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: label
                });
                console.log(`  â– ç§»é™¤æ ‡ç­¾: ${label}`);
              } catch (e) {
                // æ ‡ç­¾å¯èƒ½å·²ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
              }
            }
          }

          // æ·»åŠ ç›®æ ‡æ ‡ç­¾
          if (!currentLabels.includes(targetLabel)) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: [targetLabel]
            });
            console.log(`  â• æ·»åŠ æ ‡ç­¾: ${targetLabel}`);
          }

          // å¯é€‰ï¼šæ·»åŠ è¯„è®º
          if (addComment && commentBody) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });
            console.log(`  ğŸ’¬ æ·»åŠ è¯„è®º`);
          }

          console.log(`âœ… Issue #${issueNumber} çŠ¶æ€å·²æ›´æ–°ä¸º: ${status}`);
