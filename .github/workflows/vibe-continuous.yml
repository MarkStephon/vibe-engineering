name: Vibe Continuous - 任务监控与自动迭代引擎

on:
  # 每 24 小时检查一次（24 小时自动迭代）
  schedule:
    - cron: '0 0 * * *'
  # 支持手动触发
  workflow_dispatch:
    inputs:
      issue_number:
        description: '指定检测的 Issue 编号（留空则检测所有）'
        required: false
        type: string
      mode:
        description: '运行模式'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto          # 自动模式：scan + clean-stale + retry-failed
          - scan          # 扫描所有进行中的 issue
          - check         # 仅检测状态，不做任何操作
          - continue      # 继续处理未完成任务
          - verify        # 验收模式：检测完成度，通过则关闭 issue
          - clean-stale   # 清理超时任务（标记为 stale）
          - retry-failed  # 重试失败的任务

concurrency:
  group: vibe-continuous
  cancel-in-progress: false

jobs:
  continuous-iteration:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      pull-requests: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Vibe Continuous Script
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/vibe-continuous.js');
            await script({
              github,
              context,
              core,
              mode: '${{ github.event.inputs.mode }}' || 'auto',
              specificIssue: '${{ github.event.inputs.issue_number }}'
            });
