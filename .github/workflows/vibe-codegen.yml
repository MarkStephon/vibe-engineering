name: Vibe Codegen Agent

on:
  issue_comment:
    types: [created]

jobs:
  codegen:
    # åªæœ‰å½“è¯„è®ºåŒ…å« /codegen æŒ‡ä»¤æ—¶æ‰è§¦å‘
    if: contains(github.event.comment.body, '/codegen')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: "Vibe Agent: Execute Codegen"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_CONTEXT: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        uses: actions/github-script@v7
        with:
          script: |
            async function runCodegen() {
              const branchName = `ai-codegen-${context.issue.number}-${Date.now()}`;
              
              // 1. è°ƒç”¨ OpenRouter è·å–æ–‡ä»¶æŒ‡ä»¤ (ä½¿ç”¨åŸç”Ÿ fetch é¿å…ä¾èµ–æŠ¥é”™)
              const prompt = `ä½ æ˜¯ä¸€ä¸ªèµ„æ·±å…¨æ ˆå·¥ç¨‹å¸ˆã€‚åŸºäºä»¥ä¸‹éœ€æ±‚ï¼Œè¯·ç›´æ¥è¾“å‡ºéœ€è¦åˆ›å»ºçš„æ–‡ä»¶è·¯å¾„å’Œå®Œæ•´ä»£ç ã€‚
              éœ€æ±‚æ ‡é¢˜ï¼š${process.env.ISSUE_TITLE}
              éœ€æ±‚æè¿°ï¼š${process.env.ISSUE_CONTEXT}
              è¦æ±‚ï¼š
              1. è¿”å›æ ¼å¼å¿…é¡»æ˜¯ JSON å¯¹è±¡ï¼Œç»“æ„ä¸º {"files": [{"path": "è·¯å¾„", "content": "ä»£ç å†…å®¹"}]}ã€‚
              2. è·¯å¾„å¿…é¡»åŒ…å« backend/ æˆ– frontend/ ç›®å½•ã€‚
              3. ä½¿ç”¨ Go (GORM) å’Œ Next.js (TS) å®ç°ã€‚`;

              console.log("Calling OpenRouter...");
              const aiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: "anthropic/claude-3.5-sonnet",
                  messages: [{ role: "user", content: prompt }],
                  response_format: { type: "json_object" }
                })
              });

              const aiData = await aiRes.json();
              if (!aiData.choices) throw new Error("AI è¿”å›æ•°æ®å¼‚å¸¸");
              
              const { files } = JSON.parse(aiData.choices[0].message.content);
              console.log(`AI generated ${files.length} files.`);

              // 2. åˆ›å»ºæ–°åˆ†æ”¯
              console.log(`Creating branch: ${branchName}`);
              const baseRef = await github.rest.git.getRef({...context.repo, ref: 'heads/main'});
              await github.rest.git.createRef({
                ...context.repo,
                ref: `refs/heads/${branchName}`,
                sha: baseRef.data.object.sha
              });

              // 3. é€ä¸ªå†™å…¥æ–‡ä»¶åˆ°åˆ†æ”¯
              for (const file of files) {
                console.log(`Writing: ${file.path}`);
                await github.rest.repos.createOrUpdateFileContents({
                  ...context.repo,
                  path: file.path,
                  message: `feat: ai-codegen for #${context.issue.number}`,
                  content: Buffer.from(file.content).toString('base64'),
                  branch: branchName
                });
              }

              // 4. è‡ªåŠ¨åˆ›å»º Pull Request
              console.log("Creating PR...");
              const pr = await github.rest.pulls.create({
                ...context.repo,
                title: `[AI Codegen] ${process.env.ISSUE_TITLE}`,
                head: branchName,
                base: 'main',
                body: `ğŸ¤– **Vibe AI Codegen äº¤ä»˜æŠ¥å‘Š**\n\nå·²æ ¹æ® Issue #${context.issue.number} è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼š\n${files.map(f => `- \`${f.path}\``).join('\n')}\n\nè¯·æ£€æŸ¥å¹¶è¿›è¡Œåç»­é€»è¾‘è¡¥å…¨ã€‚`
              });

              // 5. åœ¨åŸ Issue ä¸‹å›å¤ç¡®è®¤
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âœ… **ä»£ç ç”ŸæˆæˆåŠŸï¼**\nä»£ç å·²æ¨é€åˆ°æ–°åˆ†æ”¯å¹¶åˆ›å»ºäº† PRï¼š${pr.data.html_url}\nå·¥ç¨‹å¸ˆä»¬å¯ä»¥å¼€å§‹æ¥åŠ›äº†ï¼`
              });
            }

            await runCodegen();
