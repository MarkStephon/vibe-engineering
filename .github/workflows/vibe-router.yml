name: Vibe Router - AI éœ€æ±‚å¤æ‚åº¦è·¯ç”±

on:
  issues:
    types: [opened]

jobs:
  route:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    outputs:
      complexity: ${{ steps.analyze.outputs.complexity }}
      reasoning: ${{ steps.analyze.outputs.reasoning }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load Prompt Template
        id: prompt
        uses: ./.github/actions/load-prompt
        with:
          template: router/complexity-analyzer.md
          variables: |
            {
              "title": ${{ toJson(github.event.issue.title) }},
              "body": ${{ toJson(github.event.issue.body) }}
            }

      - name: Analyze Issue Complexity
        id: analyze
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PROMPT_CONTENT: ${{ steps.prompt.outputs.prompt }}
        with:
          script: |
            const script = require('./.github/scripts/vibe-router.js');
            await script({
              github,
              context,
              core,
              promptContent: process.env.PROMPT_CONTENT
            });

  # è§¦å‘å¯¹åº”çš„ Agent (ä½¿ç”¨ workflow_dispatch æ›¿ä»£ workflow_callï¼Œä»¥æ­£ç¡®ä¼ é€’ Issue ä¿¡æ¯)
  trigger-simple:
    needs: route
    if: needs.route.outputs.complexity == 'S'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger Simple Agent
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'agent-simple.yml',
              ref: 'main',
              inputs: {
                issue_number: String(context.payload.issue.number)
              }
            });
            console.log(`ğŸš€ å·²è§¦å‘ Simple Agent for Issue #${context.payload.issue.number}`);

  trigger-medium:
    needs: route
    if: needs.route.outputs.complexity == 'M'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger Medium Agent
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'agent-medium.yml',
              ref: 'main',
              inputs: {
                issue_number: String(context.payload.issue.number)
              }
            });
            console.log(`ğŸš€ å·²è§¦å‘ Medium Agent for Issue #${context.payload.issue.number}`);

  trigger-complex:
    needs: route
    if: needs.route.outputs.complexity == 'L'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger Complex Agent
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'agent-complex.yml',
              ref: 'main',
              inputs: {
                issue_number: String(context.payload.issue.number)
              }
            });
            console.log(`ğŸš€ å·²è§¦å‘ Complex Agent for Issue #${context.payload.issue.number}`);
