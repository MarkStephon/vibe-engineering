name: Agent Architect (Plan FE)

on:
  issue_comment:
    types: [created]

jobs:
  architect:
    # è§¦å‘æŒ‡ä»¤ï¼š/plan-fe
    if: contains(github.event.comment.body, '/plan-fe')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Generate File Tree
        id: file_tree
        run: |
          # ç”Ÿæˆé¡¹ç›®ç›®å½•ç»“æ„ (æ’é™¤å¹²æ‰°é¡¹)
          # maxdepth 5 æ§åˆ¶æ·±åº¦ï¼Œé˜²æ­¢ Token æº¢å‡º
          TREE=$(find . -maxdepth 5 -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/dist*' -not -path '*/build*' -not -path '*/.next*' | sed 's|./||' | sort)
          
          # å°†ç»“æœå†™å…¥ç¯å¢ƒå˜é‡ (å¤„ç†å¤šè¡Œå­—ç¬¦ä¸²)
          echo "TREE<<EOF" >> $GITHUB_ENV
          echo "$TREE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Analyze Structure & Plan
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PROJECT_TREE: ${{ env.TREE }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        with:
          script: |
            const issueBody = process.env.ISSUE_BODY;
            const tree = process.env.PROJECT_TREE;
            const commentBody = process.env.COMMENT_BODY;
            
            console.log("ğŸš€ æ¶æ„å¸ˆå¼€å§‹åˆ†æ...");

            // 1. è‡ªåŠ¨å¯»æ‰¾å¹¶è¯»å–çˆ¶çº§ Issue
            const parentRegex = /(?:Parent|Ref|çˆ¶ä»»åŠ¡|çˆ¶çº§|çˆ¶éœ€æ±‚|å…³è”çˆ¶éœ€æ±‚)[\s:ï¼š]+#(\d+)/i;
            const parentMatch = issueBody.match(parentRegex);
            let fullContext = issueBody;

            if (parentMatch) {
              const parentId = parentMatch[1];
              console.log(`ğŸ”— å‘ç°å…³è”çˆ¶éœ€æ±‚: #${parentId}`);
              try {
                const parentIssue = await github.rest.issues.get({
                  ...context.repo,
                  issue_number: parentId
                });
                fullContext += `\n\n--- [ç³»ç»Ÿè¿½åŠ ï¼šçˆ¶çº§æ¶æ„è§„èŒƒ (Issue #${parentId})] ---\n${parentIssue.data.body}`;
              } catch (e) {
                console.log(`âš ï¸ è¯»å–çˆ¶çº§éœ€æ±‚å¤±è´¥: ${e.message}`);
              }
            }

            // 2. æ„å»º Prompt
            const prompt = `ä½ æ˜¯ä¸€åèµ„æ·±å‰ç«¯æ¶æ„å¸ˆ (Next.js ä¸“å®¶)ã€‚
            
            ã€ä»»åŠ¡ç›®æ ‡ã€‘
            åˆ†æç”¨æˆ·éœ€æ±‚ï¼ŒåŸºäºå½“å‰é¡¹ç›®ç»“æ„ï¼Œè§„åˆ’æ–‡ä»¶è·¯å¾„å’Œç›®å½•ç»“æ„ã€‚
            **æ³¨æ„ï¼šä¸è¦å†™å…·ä½“çš„ä»£ç å®ç°ï¼Œåªè¾“å‡ºè®¾è®¡æ–¹æ¡ˆå’Œæ–‡ä»¶åˆ—è¡¨ã€‚**

            ã€å½“å‰é¡¹ç›®ç›®å½•ç»“æ„ã€‘
            ${tree}

            ã€éœ€æ±‚æè¿° (å«çˆ¶çº§è§„èŒƒ)ã€‘
            ${fullContext}
            
            ã€è¡¥å……æŒ‡ä»¤ã€‘
            ${commentBody}

            ã€ä½ çš„å·¥ä½œã€‘
            è¯·å‘Šè¯‰å·¥ç¨‹å¸ˆåº”è¯¥åˆ›å»ºæˆ–ä¿®æ”¹å“ªäº›æ–‡ä»¶ã€‚
            1. **è·¯å¾„æ£€æŸ¥**ï¼šä¸¥æ ¼éµå®ˆ Next.js App Router (app/page.tsx) è§„èŒƒã€‚
            2. **å¤ç”¨æ£€æŸ¥**ï¼šå¦‚æœç›®å½•ä¸­å·²æœ‰ \`components/ui/button.tsx\` æˆ– \`utils/request.ts\`ï¼Œè¯·æ˜ç¡®æŒ‡å‡ºåº”å¤ç”¨å®ƒï¼Œä¸è¦é‡å¤é€ è½®å­ã€‚
            3. **æ¶æ„åˆç†æ€§**ï¼šå°† UI ç»„ä»¶ã€é¡µé¢é€»è¾‘ã€å·¥å…·å‡½æ•°åˆ†å¼€æ”¾ç½®ã€‚

            ã€è¾“å‡ºæ ¼å¼ã€‘
            è¯·ç›´æ¥å›å¤ä¸€ä¸ª Markdown åˆ—è¡¨ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
            
            ## ğŸ—ï¸ å‰ç«¯å®æ–½æ–¹æ¡ˆ
            å»ºè®®åˆ›å»º/ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼š
            - \`frontend/app/xxx/page.tsx\`: (è¯´æ˜ç”¨é€”)
            - \`frontend/components/xxx.tsx\`: (è¯´æ˜ç»„ä»¶é€»è¾‘)
            
            ### è®¾è®¡æ€è·¯ï¼š
            (ç®€è¿°ä¸ºä»€ä¹ˆè¿™ä¹ˆåˆ†é…ç›®å½•ï¼Œä»¥åŠéœ€è¦å¤ç”¨å“ªäº›ç°æœ‰æ–‡ä»¶)`;

            console.log("ğŸ¤– æ­£åœ¨è°ƒç”¨ OpenRouter AI...");

            // 3. è°ƒç”¨ AI
            const aiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-3.5-sonnet",
                messages: [{ role: "user", content: prompt }]
              })
            });

            if (!aiRes.ok) {
                const errText = await aiRes.text();
                throw new Error(`OpenRouter Error: ${aiRes.status} - ${errText}`);
            }
            
            const aiData = await aiRes.json();
            const plan = aiData.choices[0].message.content;

            // 4. å›å¤è¯„è®º
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: plan
            });
            console.log("âœ… æ–¹æ¡ˆå·²å‘å¸ƒåˆ°è¯„è®ºåŒº");