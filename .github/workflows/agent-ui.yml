name: Vibe UI Agent

on:
  issue_comment:
    types: [created]

jobs:
  ui-agent:
    if: |
      contains(github.event.comment.body, '/agent-ui') ||
      contains(github.event.comment.body, '/agent ui')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Vibe UI Agent - Generate UI Spec
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        with:
          script: |
            async function runUIAgent() {
              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const issue_number = context.issue.number;
              const commentBody = context.payload.comment.body || "";

              // æå–ç”¨æˆ·é¢å¤–æŒ‡ä»¤
              const userExtra = commentBody
                .replace(/\/agent-ui\b/i, "")
                .replace(/\/agent ui\b/i, "")
                .trim();

              const pmRaw = [
                "PRD TITLE:",
                process.env.ISSUE_TITLE || "",
                "",
                "PRD BODY:",
                process.env.ISSUE_BODY || ""
              ].join("\n");

              // ==================== Step 1: PM Compiler ====================
              console.log("Step 1: è¿è¡Œ PM Compilerï¼Œå°† PRD è½¬æ¢ä¸º AI å¯æ‰§è¡ŒæŒ‡ä»¤...");
              
              const pmPrompt = [
                "ä½ æ˜¯ä¸€ä¸ªã€éœ€æ±‚ç¼–è¯‘å™¨ï¼ˆPM Requirement Compilerï¼‰ã€‘ã€‚",
                "",
                "ä½ çš„èŒè´£æ˜¯å°†ã€äººç±» PM ç¼–å†™çš„éœ€æ±‚æ–‡æœ¬ã€‘è½¬æ¢ä¸ºã€æ¸…æ™°çš„äº§å“éœ€æ±‚è§„æ ¼ã€‘ã€‚",
                "ä½ å¿…é¡»å‡è®¾åŸå§‹ PM æ–‡æ¡£å¯èƒ½ä¸å®Œæ•´ã€å¯èƒ½å­˜åœ¨æ­§ä¹‰ã€å¯èƒ½æ··åˆç›®æ ‡/æ–¹æ¡ˆ/å®ç°çŒœæµ‹ã€‚",
                "",
                "ä½ çš„ç›®æ ‡ï¼š",
                "- æ¶ˆé™¤æ­§ä¹‰",
                "- å†»ç»“äº‹å®",
                "- æ˜ç¡®ç¦æ­¢é¡¹",
                "- ç”Ÿæˆä¸€ä¸ªæ¸…æ™°çš„äº§å“éœ€æ±‚è§„æ ¼",
                "- ä¸å¾—æ–°å¢åŸéœ€æ±‚é‡Œä¸å­˜åœ¨çš„æ–°åŠŸèƒ½",
                "",
                "====================",
                "è¾“å…¥ï¼ˆPM åŸå§‹éœ€æ±‚ï¼‰",
                "====================",
                pmRaw,
                "",
                userExtra ? "====================\nç”¨æˆ·é¢å¤–æŒ‡ä»¤\n====================\n" + userExtra + "\n" : "",
                "====================",
                "å¼ºåˆ¶å¤„ç†æ­¥éª¤",
                "====================",
                "Step 1ï¼šæå–ã€äº§å“ç›®æ ‡ã€‘ï¼ˆä¸€å¥è¯ï¼Œä¸å«æ–¹æ¡ˆç»†èŠ‚ï¼‰",
                "Step 2ï¼šæå–ã€æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œã€‘ï¼ˆç”¨æˆ·åšä»€ä¹ˆ â†’ ç³»ç»Ÿå¿…é¡»å‘ç”Ÿä»€ä¹ˆï¼‰",
                "Step 3ï¼šå†»ç»“ã€è¾“å…¥è§„åˆ™ã€‘ï¼ˆä½ç½®/å½¢å¼/æ•°é‡é™åˆ¶ï¼‰",
                "Step 4ï¼šå†»ç»“ã€è¾“å‡ºè§„åˆ™ã€‘ï¼ˆå½¢æ€/ä½ç½®/ç»“æ„/é¡ºåºçº¦æŸï¼‰",
                "Step 5ï¼šå†»ç»“ã€è§’è‰²èŒè´£ã€‘ï¼ˆLLM ç”ŸæˆèŒƒå›´ã€æ˜¯å¦å…è®¸ç³»ç»Ÿç»•è¿‡ LLMï¼‰",
                "Step 6ï¼šç”Ÿæˆã€ç¦æ­¢è¡Œä¸ºåˆ—è¡¨ã€‘ï¼ˆAI ç»å¯¹ä¸èƒ½åšçš„äº‹ï¼‰",
                "Step 7ï¼šç”Ÿæˆã€å¼‚å¸¸ä¸è¾¹ç•Œè§„åˆ™ã€‘ï¼ˆå¤±è´¥æ—¶ç”¨æˆ·å¯è§æç¤ºï¼‰",
                "Step 8ï¼šå¤„ç†ã€æ­§ä¹‰ã€‘ï¼ˆé€‰æ‹©ä¸€ç§æœ€ä¿å®ˆè§£é‡Šå¹¶è®°å½•ï¼Œä¸å¾—ä¿ç•™å¤šè§£ï¼‰",
                "",
                "====================",
                "è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ï¼‰",
                "====================",
                "å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡º JSONï¼Œä¸å¾—æ–°å¢æˆ–åˆ å‡å­—æ®µï¼š",
                "",
                "{",
                '  "product_goal": "äº§å“ç›®æ ‡ï¼ˆä¸€å¥è¯æ€»ç»“ç”¨æˆ·æƒ³è¦ä»€ä¹ˆï¼‰",',
                '  "user_actions": ["ç”¨æˆ·åŠ¨ä½œ1 â†’ ç³»ç»Ÿååº”", "ç”¨æˆ·åŠ¨ä½œ2 â†’ ç³»ç»Ÿååº”"],',
                '  "input_rules": ["è¾“å…¥è§„åˆ™1", "è¾“å…¥è§„åˆ™2"],',
                '  "output_rules": ["è¾“å‡ºè§„åˆ™1", "è¾“å‡ºè§„åˆ™2"],',
                '  "ui_facts": ["UIäº‹å®1", "UIäº‹å®2"],',
                '  "llm_responsibilities": ["LLMèŒè´£1", "LLMèŒè´£2"],',
                '  "forbidden_actions": ["ç¦æ­¢è¡Œä¸º1", "ç¦æ­¢è¡Œä¸º2"],',
                '  "edge_cases": ["å¼‚å¸¸å¤„ç†1", "å¼‚å¸¸å¤„ç†2"],',
                '  "disambiguation_notes": ["æ­§ä¹‰å¤„ç†è¯´æ˜1", "æ­§ä¹‰å¤„ç†è¯´æ˜2"]',
                "}",
                "",
                "åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚",
                "",
                "ã€å…³é”®çº¦æŸã€‘",
                "- ç¦æ­¢å‘ç”¨æˆ·æé—®æˆ–è¯·æ±‚æ¾„æ¸…",
                "- é‡åˆ°æ­§ä¹‰æ—¶ï¼Œå¿…é¡»è‡ªè¡Œé€‰æ‹©æœ€ä¿å®ˆçš„è§£é‡Š",
                "- æ— è®ºéœ€æ±‚å¤šä¹ˆæ¨¡ç³Šï¼Œéƒ½å¿…é¡»è¾“å‡ºå®Œæ•´çš„ JSON ç»“æ„",
                "- åœ¨ disambiguation_notes ä¸­è®°å½•ä½ çš„è§£é‡Šå†³ç­–"
              ].join("\n");

              const pmRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": "Bearer " + process.env.OPENROUTER_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: pmPrompt }],
                  temperature: 0.3
                })
              });

              if (!pmRes.ok) {
                const err = await pmRes.text();
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **PM Compiler è¯·æ±‚å¤±è´¥**\n\nHTTP: " + pmRes.status + "\n\n```\n" + err.substring(0, 1500) + "\n```"
                });
                throw new Error("PM Compiler failed: " + pmRes.status);
              }

              const pmData = await pmRes.json();
              const pmRawContent = pmData?.choices?.[0]?.message?.content || "";
              
              // è§£æ PM Compiler è¾“å‡ºçš„ JSON
              let pmResult;
              try {
                let jsonStr = pmRawContent.trim();
                const jsonMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (jsonMatch) {
                  jsonStr = jsonMatch[1].trim();
                } else {
                  const firstBrace = jsonStr.indexOf("{");
                  const lastBrace = jsonStr.lastIndexOf("}");
                  if (firstBrace !== -1 && lastBrace !== -1) {
                    jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                  }
                }
                pmResult = JSON.parse(jsonStr);
                console.log("âœ… PM Compiler è¾“å‡ºè§£ææˆåŠŸ");
              } catch (e) {
                console.error("PM Compiler JSON è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬");
                console.error("åŸå§‹å†…å®¹:", pmRawContent.substring(0, 500));
                
                if (pmRawContent.includes("è¯·ç¡®è®¤") || pmRawContent.includes("è¯·æ˜ç¡®") || pmRawContent.includes("è¯·å‘Šè¯‰æˆ‘")) {
                  await github.rest.issues.createComment({
                    owner, repo, issue_number,
                    body: [
                      "âš ï¸ **PM Compiler éœ€è¦æ›´æ˜ç¡®çš„éœ€æ±‚**",
                      "",
                      "æ¨¡å‹è®¤ä¸ºéœ€æ±‚å­˜åœ¨æ­§ä¹‰ï¼Œè¯·åœ¨ Issue ä¸­è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼š",
                      "",
                      pmRawContent,
                      "",
                      "---",
                      "è¡¥å……ä¿¡æ¯åï¼Œå†æ¬¡æ‰§è¡Œ `/agent-ui`"
                    ].join("\n")
                  });
                  throw new Error("éœ€æ±‚å­˜åœ¨æ­§ä¹‰ï¼Œå·²è¯·æ±‚ç”¨æˆ·æ¾„æ¸…");
                }
                
                pmResult = { raw: pmRawContent };
              }

              // ==================== Step 2: UI Spec Generator ====================
              console.log("Step 2: è¿è¡Œ UI Spec Generatorï¼Œç”Ÿæˆ UI è®¾è®¡è§„æ ¼...");

              // æ ¼å¼åŒ– PM ç»“æœ
              let compiledRequirement;
              if (pmResult.raw) {
                compiledRequirement = pmRawContent;
              } else {
                compiledRequirement = [
                  "## äº§å“ç›®æ ‡",
                  pmResult.product_goal || "æœªå®šä¹‰",
                  "",
                  "## æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œ",
                  (pmResult.user_actions || []).map((a, i) => (i + 1) + ". " + a).join("\n"),
                  "",
                  "## è¾“å…¥è§„åˆ™",
                  (pmResult.input_rules || []).map(r => "- " + r).join("\n"),
                  "",
                  "## è¾“å‡ºè§„åˆ™",
                  (pmResult.output_rules || []).map(r => "- " + r).join("\n"),
                  "",
                  "## UI äº‹å®",
                  (pmResult.ui_facts || []).map(f => "- " + f).join("\n"),
                  "",
                  "## LLM èŒè´£",
                  (pmResult.llm_responsibilities || []).map(r => "- " + r).join("\n"),
                  "",
                  "## ç¦æ­¢è¡Œä¸º",
                  (pmResult.forbidden_actions || []).map(f => "- " + f).join("\n"),
                  "",
                  "## å¼‚å¸¸ä¸è¾¹ç•Œ",
                  (pmResult.edge_cases || []).map(e => "- " + e).join("\n"),
                  "",
                  "## æ­§ä¹‰å¤„ç†è¯´æ˜",
                  (pmResult.disambiguation_notes || []).map(n => "- " + n).join("\n")
                ].join("\n");
              }

              const uiPrompt = [
                "ä½ æ˜¯ UI è®¾è®¡è§„æ ¼ç”Ÿæˆå™¨ã€‚",
                "",
                "å°†äº§å“éœ€æ±‚è½¬æ¢ä¸ºã€UI è®¾è®¡è§„æ ¼ã€‘ï¼Œæè¿°ç•Œé¢åº”è¯¥å¦‚ä½•å‘ˆç°å’Œäº¤äº’ã€‚",
                "**æ³¨æ„ï¼šåªå…³æ³¨ UI è®¾è®¡å±‚é¢ï¼Œä¸æ¶‰åŠå…·ä½“çš„æ–‡ä»¶è·¯å¾„å’Œä»£ç å®ç°ã€‚**",
                "",
                "====================",
                "å¯ç”¨çš„ shadcn/ui ç»„ä»¶åº“",
                "====================",
                "é¡¹ç›®å·²é›†æˆ shadcn/uiï¼Œå¿…é¡»ä¼˜å…ˆä½¿ç”¨ä»¥ä¸‹ç°æœ‰ç»„ä»¶ï¼š",
                "",
                "**å¸ƒå±€ç±»**: Card, Accordion, Collapsible, Tabs, Separator, Resizable, ScrollArea, AspectRatio",
                "**è¡¨å•ç±»**: Button, Input, Textarea, Checkbox, RadioGroup, Select, Switch, Slider, Form, Field, Label, InputOTP, InputGroup",
                "**åé¦ˆç±»**: Alert, AlertDialog, Dialog, Drawer, Sheet, Popover, HoverCard, Tooltip, Sonner(toast), Progress, Skeleton, Spinner, Empty",
                "**å¯¼èˆªç±»**: Breadcrumb, NavigationMenu, Menubar, DropdownMenu, ContextMenu, Command, Pagination, Sidebar",
                "**æ•°æ®å±•ç¤ºç±»**: Avatar, Badge, Table, Calendar, Carousel, Chart, Kbd",
                "**äº¤äº’ç±»**: Toggle, ToggleGroup, ButtonGroup",
                "",
                "====================",
                "ğŸ¨ Base.org è®¾è®¡ç³»ç»Ÿè§„èŒƒï¼ˆå¿…é¡»ä¸¥æ ¼éµå¾ªï¼‰",
                "====================",
                "",
                "é¡¹ç›®é‡‡ç”¨ **Base.org å®˜æ–¹è®¾è®¡è¯­è¨€**ï¼Œæ ¸å¿ƒå“²å­¦æ˜¯ **\"æè‡´å…‹åˆ¶ + ç²¾å‡†çˆ†å‘\"**ï¼š",
                "- 90% çš„é¢ç§¯æ˜¯å¹²å‡€çš„ç°åº¦/ç™½è‰²ç©ºé—´",
                "- åªæœ‰å…³é”®è¡ŒåŠ¨ç‚¹æ‰é‡Šæ”¾å¼ºçƒˆçš„ Base Blue èƒ½é‡",
                "",
                "### æ ¸å¿ƒè®¾è®¡çº¦æŸ",
                "- **é¢œè‰²**ï¼šBase Blue (#0000ff) ä½œä¸ºå”¯ä¸€ä¸»è‰²ï¼Œ90% åŒºåŸŸä½¿ç”¨ç°åº¦ï¼Œç¦æ­¢å…¶ä»–ä¸»è‰²è°ƒ",
                "- **åœ†è§’**ï¼šæŒ‰é’®/è¾“å…¥æ¡† 12pxï¼Œå¡ç‰‡ 12-16pxï¼Œå¤§å¡ç‰‡/æ¨¡æ€æ¡† 16-24px",
                "- **æ— é˜´å½±**ï¼šç¦æ­¢ä½¿ç”¨é˜´å½±ï¼Œé€šè¿‡èƒŒæ™¯è‰²å·®å¼‚åˆ›å»ºå±‚æ¬¡",
                "- **æ— è¾¹æ¡†**ï¼šæŒ‰é’®/å¡ç‰‡/è¾“å…¥æ¡†å‡æ— è¾¹æ¡†ï¼Œé€šè¿‡èƒŒæ™¯è‰²å˜åŒ–è¡¨è¾¾çŠ¶æ€",
                "- **é—´è·**ï¼šä½¿ç”¨è¾ƒå¤§é—´è·ï¼Œä¿æŒå‘¼å¸æ„Ÿ",
                "",
                "**æ³¨æ„**ï¼šè¯¦ç»†çš„è®¾è®¡å®ç°è§„èŒƒï¼ˆå¦‚å…·ä½“çš„ Tailwind ç±»åã€åŠ¨ç”»ç»†èŠ‚ç­‰ï¼‰ç”±å‰ç«¯å®ç°ä»£ç æ—¶éµå¾ªï¼Œæ­¤å¤„åªæè¿°è®¾è®¡çº¦æŸã€‚",
                "",
                "====================",
                "éœ€æ±‚",
                "====================",
                compiledRequirement,
                "",
                "====================",
                "è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼éµå¾ªï¼‰",
                "====================",
                "",
                "## åŠŸèƒ½æ¦‚è¿°",
                "ä¸€æ®µè¯æè¿°è¦å®ç°ä»€ä¹ˆåŠŸèƒ½",
                "",
                "## é¡µé¢å¸ƒå±€",
                "æè¿°æ•´ä½“é¡µé¢å¸ƒå±€ç»“æ„ï¼ˆä½¿ç”¨ ASCII æˆ–æ–‡å­—æè¿°ï¼‰",
                "",
                "## ç»„ä»¶è®¾è®¡",
                "æ¯ä¸ªéœ€è¦çš„ UI ç»„ä»¶ï¼š",
                "",
                "### ç»„ä»¶åç§°",
                "- åŠŸèƒ½æè¿°ï¼šåšä»€ä¹ˆ",
                "- ä½¿ç”¨çš„ shadcn/ui ç»„ä»¶ï¼šButton, Card ç­‰",
                "- è§†è§‰æ ·å¼ï¼šé¢œè‰²ã€å¤§å°ã€é—´è·ç­‰å…³é”®æ ·å¼",
                "- çŠ¶æ€å˜åŒ–ï¼šhoverã€loadingã€disabledã€error ç­‰çŠ¶æ€",
                "",
                "## äº¤äº’æµç¨‹",
                "ç”¨æˆ·æ“ä½œ â†’ ç•Œé¢ååº”çš„å®Œæ•´æµç¨‹",
                "",
                "## å“åº”å¼è®¾è®¡",
                "ä¸åŒå±å¹•å°ºå¯¸ä¸‹çš„é€‚é…ç­–ç•¥",
                "",
                "## æ ·å¼è§„èŒƒ",
                "- ä¸»é¢˜è‰²å½©ï¼šBase Blue (#0000ff) ä½œä¸ºä¸»è‰²ï¼Œ90% åŒºåŸŸä½¿ç”¨ç°åº¦",
                "- å­—ä½“ï¼šInter å­—ä½“ï¼Œéµå¾ª Base.org æ’ç‰ˆè§„èŒƒ",
                "- é—´è·ï¼šä½¿ç”¨è¾ƒå¤§é—´è·ï¼Œä¿æŒå‘¼å¸æ„Ÿ",
                "- åœ†è§’ï¼šæŒ‰é’®/è¾“å…¥æ¡† 12pxï¼Œå¡ç‰‡ 12-16pxï¼Œå¤§å¡ç‰‡/æ¨¡æ€æ¡† 16-24px",
                "- æ— é˜´å½±ã€æ— è¾¹æ¡†è®¾è®¡ï¼šé€šè¿‡èƒŒæ™¯è‰²å·®å¼‚å’Œå˜åŒ–è¡¨è¾¾å±‚æ¬¡å’ŒçŠ¶æ€",
                "",
                "## çº¦æŸ",
                "- âœ… å¿…é¡»å®ç°çš„ UI å…ƒç´ ",
                "- âŒ ç¦æ­¢çš„ UI è®¾è®¡",
                "- âš ï¸ è¾¹ç•Œæƒ…å†µçš„ UI å¤„ç†",
                "",
                "====================",
                "è§„åˆ™",
                "====================",
                "- åªè¾“å‡º UI è®¾è®¡è§„æ ¼ï¼Œä¸è¦å†™ä»£ç ",
                "- **ä¸è¦æ¶‰åŠå…·ä½“çš„æ–‡ä»¶è·¯å¾„**ï¼ˆå¦‚ frontend/app/xxxï¼‰",
                "- **ä¸è¦åˆ†æç°æœ‰ä»£ç ç»“æ„**",
                "- å¿…é¡»ä¼˜å…ˆä½¿ç”¨ shadcn/ui ç»„ä»¶",
                "- **å¿…é¡»ä¸¥æ ¼éµå¾ª Base.org è®¾è®¡ç³»ç»Ÿè§„èŒƒ**ï¼ˆé¢œè‰²ã€åœ†è§’ã€æ— é˜´å½±ã€æ— è¾¹æ¡†ç­‰ï¼‰",
                "- ä¸“æ³¨äºã€Œç•Œé¢åº”è¯¥é•¿ä»€ä¹ˆæ ·ã€å’Œã€Œå¦‚ä½•äº¤äº’ã€"
              ].join("\n");

              const uiRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": "Bearer " + process.env.OPENROUTER_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: uiPrompt }],
                  temperature: 0.5
                })
              });

              if (!uiRes.ok) {
                const err = await uiRes.text();
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **UI Spec Generator è¯·æ±‚å¤±è´¥**\n\nHTTP: " + uiRes.status + "\n\n```\n" + err.substring(0, 1500) + "\n```"
                });
                throw new Error("UI Spec Generator failed: " + uiRes.status);
              }

              const uiData = await uiRes.json();
              const uiSpec = uiData?.choices?.[0]?.message?.content || "";

              if (!uiSpec.trim()) {
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **UI Spec Generator è¿”å›ä¸ºç©º**\n\næ¨¡å‹æ²¡æœ‰è¿”å›æœ‰æ•ˆå†…å®¹ï¼Œè¯·é‡è¯•ã€‚"
                });
                throw new Error("UI Spec Generator returned empty content.");
              }

              // ==================== Step 3: Post Result ====================
              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body: [
                  "ğŸ¨ **UI è®¾è®¡è§„æ ¼ (UI Design Spec)**",
                  "",
                  "---",
                  "",
                  "## éœ€æ±‚æ‘˜è¦",
                  "",
                  compiledRequirement,
                  "",
                  "---",
                  "",
                  "## UI è®¾è®¡è§„æ ¼",
                  "",
                  uiSpec.trim(),
                  "",
                  "---"
                ].join("\n")
              });

              console.log("âœ… UI Agent å®Œæˆ");
            }

            await runUIAgent();
