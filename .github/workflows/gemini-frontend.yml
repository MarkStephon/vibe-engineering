name: Vibe Frontend Agent

on:
  issue_comment:
    types: [created]

jobs:
  frontend-agent:
    if: contains(github.event.comment.body, '/agent-fe')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "vibe-frontend-agent"
          git config user.email "agent@vibe.dev"

      - name: Vibe Frontend Agent - Generate Code and Open PR
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const { execSync } = require("child_process");

            async function runFrontendAgent() {
              const { owner, repo } = context.repo;
              const issue_number = context.issue.number;
              const commentBody = context.payload.comment.body;

              // ==================== ä¸Šä¸‹æ–‡ä¿¡æ¯è¾“å‡º ====================
              console.log("=".repeat(80));
              console.log("ğŸ” FRONTEND AGENT - ä¸Šä¸‹æ–‡ä¿¡æ¯");
              console.log("=".repeat(80));
              console.log(`ğŸ“¦ Repository: ${owner}/${repo}`);
              console.log(`ğŸ“‹ Issue Number: #${issue_number}`);
              console.log(`ğŸ‘¤ Comment Author: ${context.payload.comment.user.login}`);
              console.log(`ğŸ• Comment Created: ${context.payload.comment.created_at}`);
              console.log(`ğŸ”— Comment URL: ${context.payload.comment.html_url}`);
              console.log("");
              console.log("ğŸ“ æ”¶åˆ°çš„è¯„è®ºå†…å®¹ (å®Œæ•´):");
              console.log("-".repeat(80));
              console.log(commentBody);
              console.log("-".repeat(80));
              console.log("");

              // 1. Extract UI Spec comment URLs (æ”¯æŒå¤šä¸ª URL)
              // æ”¯æŒ GitHub è‡ªåŠ¨è½¬æ¢çš„ markdown é“¾æ¥æ ¼å¼: [#139 (comment)](https://...)
              const urlPattern = /https:\/\/github\.com\/[^\s\)]+\/issues\/\d+#issuecomment-\d+/g;
              const urlMatches = commentBody.match(urlPattern) || [];

              console.log(`ğŸ” æ‰¾åˆ° ${urlMatches.length} ä¸ª URL:`);
              urlMatches.forEach((url, idx) => {
                console.log(`  ${idx + 1}. ${url}`);
              });
              console.log("");

              if (urlMatches.length === 0) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: [
                    "âŒ **ç¼ºå°‘è¯„è®º URL**",
                    "",
                    "ç”¨æ³•: `/agent-fe <github issue comment url-1> [<url-2> ...]`",
                    "",
                    "ç¤ºä¾‹ï¼ˆå•ä¸ª URLï¼‰:",
                    "```",
                    "/agent-fe https://github.com/owner/repo/issues/1#issuecomment-123456",
                    "è¯·ä½¿ç”¨æ·±è‰²ä¸»é¢˜",
                    "```",
                    "",
                    "ç¤ºä¾‹ï¼ˆå¤šä¸ª URLï¼‰:",
                    "```",
                    "/agent-fe \\",
                    "  https://github.com/owner/repo/issues/1#issuecomment-123456 \\",
                    "  https://github.com/owner/repo/issues/1#issuecomment-789012",
                    "```"
                  ].join("\n")
                });
                return;
              }

              // 1.1 Extract user instructions (text after URLs)
              let userInstructions = commentBody
                .replace(/\/agent-fe\s*/, "")
                .trim();
              
              // Remove all URLs from instructions
              urlMatches.forEach(url => {
                userInstructions = userInstructions.replace(url, "").trim();
              });

              console.log("ğŸ“Œ æå–çš„ç”¨æˆ·é¢å¤–æŒ‡ä»¤:");
              console.log("-".repeat(80));
              console.log(userInstructions || "(æ— )");
              console.log("-".repeat(80));
              console.log("");

              // 2. Fetch all UI Specs from multiple comments
              const uiSpecs = [];
              const commentUrls = [];
              
              for (const commentUrl of urlMatches) {
                try {
                  const commentId = commentUrl.split("#issuecomment-")[1];
                  console.log(`ğŸ“¥ è·å–è¯„è®ºå†…å®¹: ${commentUrl} (ID: ${commentId})`);
                  
                  const commentRes = await github.rest.issues.getComment({
                    owner,
                    repo,
                    comment_id: Number(commentId)
                  });

                  const specContent = commentRes.data.body;
                  uiSpecs.push({
                    url: commentUrl,
                    content: specContent,
                    title: specContent.split('\n')[0] || 'UI Spec'
                  });
                  commentUrls.push(commentUrl);
                  
                  console.log(`âœ… æˆåŠŸè·å–è¯„è®º ${commentId}, å†…å®¹é•¿åº¦: ${specContent.length}`);
                  console.log(`   æ ‡é¢˜: ${specContent.split('\n')[0] || '(æ— æ ‡é¢˜)'}`);
                  console.log(`   å†…å®¹é¢„è§ˆ: ${specContent.substring(0, 200)}${specContent.length > 200 ? '...' : ''}`);
                } catch (error) {
                  console.error(`âŒ è·å–è¯„è®ºå¤±è´¥ ${commentUrl}:`, error.message);
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number,
                    body: `âŒ **è·å–è¯„è®ºå¤±è´¥**: ${commentUrl}\n\né”™è¯¯: ${error.message}`
                  });
                  return;
                }
              }

              // 2.1 Combine all UI Specs
              const combinedUISpec = uiSpecs.map((spec, idx) => {
                return `## UI Spec ${idx + 1}: ${spec.title}\n\næ¥æº: ${spec.url}\n\n${spec.content}`;
              }).join("\n\n---\n\n");

              console.log(`ğŸ“‹ åˆå¹¶åçš„ UI Spec æ€»é•¿åº¦: ${combinedUISpec.length} å­—ç¬¦`);
              console.log(`ğŸ“‹ UI Spec å†…å®¹é¢„è§ˆ:`);
              console.log("-".repeat(80));
              console.log(combinedUISpec.substring(0, 500) + (combinedUISpec.length > 500 ? '\n...' : ''));
              console.log("-".repeat(80));
              console.log("");

              // Use first URL as primary reference (for backward compatibility)
              const commentUrl = commentUrls[0];

              // 2.1 Analyze requirements and generate todolist
              const analysisPrompt = `ä½ æ˜¯ä¸€ä¸ªå‰ç«¯éœ€æ±‚åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹ UI è§„æ ¼å’Œç”¨æˆ·æŒ‡ä»¤ï¼Œç”Ÿæˆéœ€æ±‚åˆ†æå’Œå¾…åŠæ¸…å•ã€‚

                UI è§„æ ¼æ¥æº${uiSpecs.length > 1 ? `ï¼ˆå…± ${uiSpecs.length} ä¸ªï¼‰` : ''}:
                ${commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n")}
                
                UI è§„æ ¼å†…å®¹:
                ${combinedUISpec}
                
                ${userInstructions ? `ç”¨æˆ·é¢å¤–æŒ‡ä»¤:\n${userInstructions}\n` : ""}è¯·è¿”å› JSON æ ¼å¼:
                {
                  "analysis": "éœ€æ±‚åˆ†ææ€»ç»“ï¼ˆ2-3å¥è¯ï¼‰",
                  "todolist": [
                    "å¾…åŠé¡¹1",
                    "å¾…åŠé¡¹2",
                    "å¾…åŠé¡¹3"
                  ]
                }
                
                åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚`;

              const analysisRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [
                    { role: "user", content: analysisPrompt }
                  ],
                  temperature: 0.3
                })
              });

              const analysisData = await analysisRes.json();
              const analysisRaw = analysisData.choices?.[0]?.message?.content;
              
              let analysisResult = { analysis: "", todolist: [] };
              if (analysisRaw) {
                console.log("ğŸ“Š éœ€æ±‚åˆ†æåŸå§‹å“åº”:");
                console.log("-".repeat(80));
                console.log(analysisRaw.substring(0, 500) + (analysisRaw.length > 500 ? '\n...' : ''));
                console.log("-".repeat(80));
                console.log("");
                
                let analysisJsonStr = analysisRaw.trim();
                const analysisJsonMatch = analysisJsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (analysisJsonMatch) {
                  analysisJsonStr = analysisJsonMatch[1].trim();
                }
                try {
                  analysisResult = JSON.parse(analysisJsonStr);
                  console.log("âœ… éœ€æ±‚åˆ†æè§£ææˆåŠŸ:");
                  console.log(`   åˆ†æ: ${analysisResult.analysis}`);
                  console.log(`   å¾…åŠæ¸…å•æ•°é‡: ${analysisResult.todolist.length}`);
                  analysisResult.todolist.forEach((item, idx) => {
                    console.log(`     ${idx + 1}. ${item}`);
                  });
                  console.log("");
                } catch (e) {
                  console.error("âŒ éœ€æ±‚åˆ†æè§£æå¤±è´¥:", e);
                  analysisResult.analysis = "éœ€æ±‚åˆ†æå®Œæˆ";
                  analysisResult.todolist = ["å®ç°å‰ç«¯ç•Œé¢"];
                }
              }

              // 2.2 è¯»å–é¡¹ç›®å†å²å’Œæ¶æ„æ–‡æ¡£
              console.log("Step 2.2: è¯»å–é¡¹ç›®å†å²å’Œæ¶æ„æ–‡æ¡£...");
              
              // è¯»å– AGENT_CHANGELOG.md - äº†è§£ä¹‹å‰çš„å˜æ›´è®°å½•
              let changelogContent = "";
              const changelogPath = path.join(process.cwd(), "frontend/AGENT_CHANGELOG.md");
              if (fs.existsSync(changelogPath)) {
                changelogContent = fs.readFileSync(changelogPath, "utf8");
                console.log(`âœ… è¯»å– AGENT_CHANGELOG.md (${changelogContent.length} å­—ç¬¦)`);
              } else {
                console.log("âš ï¸ AGENT_CHANGELOG.md ä¸å­˜åœ¨");
              }
              
              // è¯»å– ARCHITECTURE.md - äº†è§£é¡¹ç›®ç»“æ„
              let architectureContent = "";
              const architecturePath = path.join(process.cwd(), "frontend/ARCHITECTURE.md");
              if (fs.existsSync(architecturePath)) {
                architectureContent = fs.readFileSync(architecturePath, "utf8");
                console.log(`âœ… è¯»å– ARCHITECTURE.md (${architectureContent.length} å­—ç¬¦)`);
              } else {
                console.log("âš ï¸ ARCHITECTURE.md ä¸å­˜åœ¨");
              }
              
              // ä» changelog æå–å·²æœ‰æ–‡ä»¶åˆ—è¡¨
              const existingFilesFromChangelog = [];
              const filePatterns = changelogContent.match(/`frontend\/[^`]+`/g) || [];
              filePatterns.forEach(match => {
                const filePath = match.replace(/`/g, '');
                if (!existingFilesFromChangelog.includes(filePath)) {
                  existingFilesFromChangelog.push(filePath);
                }
              });
              console.log(`ğŸ“¦ ä» CHANGELOG æå–åˆ° ${existingFilesFromChangelog.length} ä¸ªå·²æœ‰æ–‡ä»¶`);
              
              // 2.3 Code-level analysis - åˆ†æè§„æ ¼ç±»å‹ã€UIå·¥ç¨‹ç»†èŠ‚ã€åç«¯æ¥å£
              console.log("Step 2.3: ä»£ç çº§åˆ«åˆ†æï¼ˆUI å·¥ç¨‹ + åç«¯æ¥å£ï¼‰...");
              
              const codeAnalysisPrompt = [
                "ä½ æ˜¯å‰ç«¯ä»£ç æ¶æ„åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹è§„æ ¼å†…å®¹ï¼Œç»“åˆé¡¹ç›®å†å²å’Œæ¶æ„ï¼Œç¡®å®šå®ç°ç­–ç•¥ã€‚",
                "",
                "====================",
                "ğŸ“‹ è¾“å…¥çš„è§„æ ¼å†…å®¹",
                "====================",
                combinedUISpec,
                "",
                userInstructions ? "====================\nç”¨æˆ·é¢å¤–æŒ‡ä»¤\n====================\n" + userInstructions + "\n" : "",
                "====================",
                "ğŸ“œ é¡¹ç›®å˜æ›´å†å²ï¼ˆAGENT_CHANGELOG.mdï¼‰",
                "====================",
                "ä»¥ä¸‹æ˜¯ä¹‹å‰ Agent çš„å˜æ›´è®°å½•ï¼Œç”¨äºåˆ¤æ–­å“ªäº›æ–‡ä»¶å·²å­˜åœ¨ã€å“ªäº›åŠŸèƒ½å·²å®ç°ï¼š",
                "",
                changelogContent.substring(0, 8000) || "ï¼ˆæ— å†å²è®°å½•ï¼‰",
                changelogContent.length > 8000 ? "\n... å†å²è®°å½•è¿‡é•¿å·²æˆªæ–­ ..." : "",
                "",
                "====================",
                "ğŸ—ï¸ é¡¹ç›®æ¶æ„ï¼ˆARCHITECTURE.md æ‘˜è¦ï¼‰",
                "====================",
                "ä»¥ä¸‹æ˜¯é¡¹ç›®çš„ç›®å½•ç»“æ„å’Œæ¨¡å—è¯´æ˜ï¼Œç”¨äºç¡®å®šæ–‡ä»¶åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼š",
                "",
                // åªæå–å…³é”®éƒ¨åˆ†ï¼šé¡¹ç›®ç»“æ„å’Œç³»ç»Ÿæ–‡ä»¶åˆ—è¡¨
                "### é¡¹ç›®ç»“æ„",
                "```",
                "frontend/",
                "â”œâ”€â”€ app/                 # Next.js App Router (é¡µé¢)",
                "â”œâ”€â”€ components/          # React ç»„ä»¶",
                "â”‚   â”œâ”€â”€ ui/             # shadcn/ui ç»„ä»¶åº“ï¼ˆåªè¯»ï¼‰",
                "â”‚   â””â”€â”€ ...             # ä¸šåŠ¡ç»„ä»¶",
                "â”œâ”€â”€ hooks/              # è‡ªå®šä¹‰ Hooks",
                "â”œâ”€â”€ lib/                # æ ¸å¿ƒåº“",
                "â”‚   â”œâ”€â”€ api/           # API æœåŠ¡å±‚",
                "â”‚   â”œâ”€â”€ config/        # é…ç½®æ¨¡å—",
                "â”‚   â”œâ”€â”€ constants/     # å¸¸é‡å®šä¹‰",
                "â”‚   â””â”€â”€ utils/         # å·¥å…·å‡½æ•°",
                "â””â”€â”€ types/              # ç±»å‹å®šä¹‰",
                "```",
                "",
                "### å·²å­˜åœ¨çš„æ–‡ä»¶ï¼ˆä» CHANGELOG æå–ï¼‰",
                existingFilesFromChangelog.length > 0 
                  ? existingFilesFromChangelog.map(f => `- ${f}`).join("\n")
                  : "ï¼ˆæ— å·²çŸ¥æ–‡ä»¶ï¼‰",
                "",
                "====================",
                "åˆ†æä»»åŠ¡",
                "====================",
                "1. è¯†åˆ«è§„æ ¼ç±»å‹ï¼ˆUIè®¾è®¡ / åç«¯æ¥å£ / æ··åˆï¼‰",
                "2. **åŸºäºå†å²è®°å½•åˆ¤æ–­**ï¼šæ˜¯æ–°å¢é¡µé¢/ç»„ä»¶ï¼Œè¿˜æ˜¯ä¿®æ”¹å·²æœ‰çš„",
                "3. åˆ†æ UI å·¥ç¨‹ç»†èŠ‚ï¼ˆç›®æ ‡é¡µé¢ã€ç»„ä»¶ç»“æ„ï¼‰",
                "4. åˆ†æåç«¯æ¥å£ï¼ˆAPI endpointsã€è¯·æ±‚/å“åº”æ ¼å¼ï¼‰",
                "",
                "====================",
                "è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ JSONï¼‰",
                "====================",
                "{",
                '  "spec_types": ["ui_design", "backend_api"],',
                '  "operation_type": "new_page | add_feature | fix_bug | refactor | style_change | remove_feature",',
                '  "page_type": "new_page | existing_page",',
                '  "target_page": "ç›®æ ‡é¡µé¢è·¯å¾„ï¼ˆå¦‚ frontend/app/page.tsxï¼‰",',
                '  "target_page_is_new": true,',
                '  "target_components": ["éœ€è¦ä¿®æ”¹æˆ–æ–°å»ºçš„ç»„ä»¶è·¯å¾„"],',
                '  "files_to_create": ["éœ€è¦æ–°å»ºçš„æ–‡ä»¶è·¯å¾„"],',
                '  "files_to_modify": ["éœ€è¦ä¿®æ”¹çš„å·²æœ‰æ–‡ä»¶è·¯å¾„"],',
                '  "change_scope": "ä¿®æ”¹èŒƒå›´æè¿°",',
                '  "preserve_list": ["éœ€è¦ä¿ç•™ä¸å˜çš„åŠŸèƒ½"],',
                '  "api_endpoints": [',
                '    {',
                '      "method": "GET | POST | PUT | DELETE",',
                '      "path": "/api/xxx",',
                '      "description": "æ¥å£æè¿°",',
                '      "request_params": {"key": "type"},',
                '      "response_format": {"key": "type"}',
                '    }',
                '  ],',
                '  "data_types": [',
                '    {',
                '      "name": "TypeName",',
                '      "fields": {"field": "type"}',
                '    }',
                '  ],',
                '  "reasoning": "åŸºäºå†å²è®°å½•å’Œé¡¹ç›®ç»“æ„çš„åˆ†ææ¨ç†"',
                "}",
                "",
                "ã€spec_types åˆ¤æ–­æŒ‡å—ã€‘",
                "- ui_design: åŒ…å« UI è®¾è®¡ã€ç»„ä»¶è®¾è®¡ã€äº¤äº’æµç¨‹ã€é¡µé¢å¸ƒå±€ç­‰",
                "- backend_api: åŒ…å« API æ¥å£å®šä¹‰ã€è¯·æ±‚å“åº”æ ¼å¼ã€æ•°æ®ç»“æ„ç­‰",
                "- å¯ä»¥åŒæ—¶åŒ…å«å¤šä¸ªç±»å‹",
                "",
                "ã€operation_type åˆ¤æ–­æŒ‡å—ã€‘",
                "- new_page: åˆ›å»ºå…¨æ–°é¡µé¢",
                "- add_feature: åœ¨ç°æœ‰é¡µé¢æ–°å¢åŠŸèƒ½ï¼ˆå…³é”®è¯ï¼šæ·»åŠ ã€æ–°å¢ã€å¢åŠ ã€å®ç°ï¼‰",
                "- fix_bug: ä¿®å¤ç°æœ‰ä»£ç é—®é¢˜ï¼ˆå…³é”®è¯ï¼šä¿®å¤ã€è§£å†³ã€bugã€é—®é¢˜ï¼‰",
                "- refactor: é‡æ„ä»£ç ï¼ŒåŠŸèƒ½ä¸å˜ï¼ˆå…³é”®è¯ï¼šé‡æ„ã€ä¼˜åŒ–ã€æ•´ç†ï¼‰",
                "- style_change: åªä¿®æ”¹æ ·å¼ï¼ˆå…³é”®è¯ï¼šæ ·å¼ã€é¢œè‰²ã€å­—ä½“ã€å¸ƒå±€ï¼‰",
                "- remove_feature: åˆ é™¤åŠŸèƒ½ï¼ˆå…³é”®è¯ï¼šåˆ é™¤ã€ç§»é™¤ã€å»æ‰ï¼‰",
                "",
                "ã€target_page åˆ¤æ–­æŒ‡å—ã€‘",
                "- å¦‚æœæåˆ°ã€Œé¦–é¡µã€ã€Œä¸»é¡µã€â†’ frontend/app/page.tsx",
                "- å¦‚æœæåˆ°æŸä¸ªå…·ä½“é¡µé¢ â†’ frontend/app/xxx/page.tsx",
                "- å¦‚æœä¸ç¡®å®š â†’ frontend/app/page.tsxï¼ˆé»˜è®¤é¦–é¡µï¼‰",
                "- **å…³é”®**ï¼šæ£€æŸ¥ CHANGELOG ä¸­æ˜¯å¦å·²æœ‰è¯¥é¡µé¢ï¼Œåˆ¤æ–­ target_page_is_new",
                "",
                "ã€target_components åˆ¤æ–­æŒ‡å—ã€‘",
                "- æ ¹æ® UI è§„æ ¼ä¸­æåˆ°çš„ç»„ä»¶åæ¨æ–­è·¯å¾„",
                "- æ–°ç»„ä»¶ â†’ frontend/components/NewComponentName.tsx",
                "- ç°æœ‰ç»„ä»¶ä¿®æ”¹ â†’ frontend/components/ExistingComponent.tsx",
                "",
                "ã€files_to_create vs files_to_modify åˆ¤æ–­æŒ‡å—ã€‘",
                "- **é‡è¦**ï¼šæ ¹æ® CHANGELOG ä¸­çš„ã€Œå·²å­˜åœ¨çš„æ–‡ä»¶ã€åˆ—è¡¨åˆ¤æ–­",
                "- å¦‚æœæ–‡ä»¶è·¯å¾„åœ¨ CHANGELOG çš„ã€Œæ–°å»ºæ–‡ä»¶ã€æˆ–ã€Œä¿®æ”¹æ–‡ä»¶ã€ä¸­å‡ºç°è¿‡ â†’ files_to_modify",
                "- å¦‚æœæ–‡ä»¶è·¯å¾„æœªå‡ºç°è¿‡ â†’ files_to_create",
                "- è¿™ä¸ªåˆ¤æ–­å†³å®šäº†ä»£ç ç”Ÿæˆæ—¶æ˜¯ã€Œå®Œæ•´ç¼–å†™ã€è¿˜æ˜¯ã€Œå¢é‡ä¿®æ”¹ã€",
                "",
                "ã€api_endpoints åˆ†ææŒ‡å—ã€‘",
                "- ä»åç«¯æ¥å£è§„æ ¼ä¸­æå–æ‰€æœ‰ API ç«¯ç‚¹",
                "- åŒ…æ‹¬è¯·æ±‚æ–¹æ³•ã€è·¯å¾„ã€å‚æ•°ã€å“åº”æ ¼å¼",
                "- å¦‚æœæ²¡æœ‰åç«¯æ¥å£è§„æ ¼ï¼Œæ­¤å­—æ®µä¸ºç©ºæ•°ç»„ []",
                "",
                "ã€data_types åˆ†ææŒ‡å—ã€‘",
                "- ä»æ¥å£è§„æ ¼ä¸­æå–éœ€è¦å®šä¹‰çš„ TypeScript ç±»å‹",
                "- åŒ…æ‹¬è¯·æ±‚ä½“ç±»å‹ã€å“åº”ä½“ç±»å‹ã€æ•°æ®æ¨¡å‹ç­‰",
                "- å¦‚æœæ²¡æœ‰éœ€è¦å®šä¹‰çš„ç±»å‹ï¼Œæ­¤å­—æ®µä¸ºç©ºæ•°ç»„ []",
                "",
                "åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"
              ].join("\n");

              const codeAnalysisRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: codeAnalysisPrompt }],
                  temperature: 0.3
                })
              });

              const codeAnalysisData = await codeAnalysisRes.json();
              const codeAnalysisRaw = codeAnalysisData.choices?.[0]?.message?.content || "";
              
              let codeAnalysisResult = {
                spec_types: ["ui_design"],
                operation_type: "add_feature",
                page_type: "existing_page",
                target_page: "frontend/app/page.tsx",
                target_page_is_new: false,
                target_components: [],
                files_to_create: [],
                files_to_modify: [],
                change_scope: "",
                preserve_list: [],
                api_endpoints: [],
                data_types: [],
                reasoning: ""
              };
              
              try {
                let jsonStr = codeAnalysisRaw.trim();
                const jsonMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (jsonMatch) {
                  jsonStr = jsonMatch[1].trim();
                } else {
                  const firstBrace = jsonStr.indexOf("{");
                  const lastBrace = jsonStr.lastIndexOf("}");
                  if (firstBrace !== -1 && lastBrace !== -1) {
                    jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                  }
                }
                codeAnalysisResult = JSON.parse(jsonStr);
                console.log("âœ… ä»£ç åˆ†æè§£ææˆåŠŸ:");
                console.log(`   è§„æ ¼ç±»å‹: ${codeAnalysisResult.spec_types?.join(", ") || "ui_design"}`);
                console.log(`   æ“ä½œç±»å‹: ${codeAnalysisResult.operation_type}`);
                console.log(`   é¡µé¢ç±»å‹: ${codeAnalysisResult.page_type}`);
                console.log(`   ç›®æ ‡é¡µé¢: ${codeAnalysisResult.target_page} (${codeAnalysisResult.target_page_is_new ? "æ–°å»º" : "å·²å­˜åœ¨"})`);
                console.log(`   æ¶‰åŠç»„ä»¶: ${codeAnalysisResult.target_components?.join(", ") || "æ— "}`);
                console.log(`   æ–°å»ºæ–‡ä»¶: ${codeAnalysisResult.files_to_create?.length || 0} ä¸ª`);
                console.log(`   ä¿®æ”¹æ–‡ä»¶: ${codeAnalysisResult.files_to_modify?.length || 0} ä¸ª`);
                console.log(`   API ç«¯ç‚¹: ${codeAnalysisResult.api_endpoints?.length || 0} ä¸ª`);
                console.log(`   æ•°æ®ç±»å‹: ${codeAnalysisResult.data_types?.length || 0} ä¸ª`);
              } catch (e) {
                console.error("âŒ ä»£ç åˆ†æè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:", e.message);
              }

              // 2.4 è¯»å–ç›®æ ‡é¡µé¢å’Œç›¸å…³ç»„ä»¶ï¼ˆå¦‚æœæ˜¯ä¿®æ”¹ç°æœ‰é¡µé¢ï¼‰
              let targetPageContent = "";
              let targetComponentsContent = {};
              
              if (codeAnalysisResult.page_type === "existing_page" && codeAnalysisResult.target_page) {
                console.log(`ğŸ“– è¯»å–ç›®æ ‡é¡µé¢: ${codeAnalysisResult.target_page}`);
                
                try {
                  const targetPath = path.join(process.cwd(), codeAnalysisResult.target_page);
                  if (fs.existsSync(targetPath)) {
                    targetPageContent = fs.readFileSync(targetPath, "utf8");
                    console.log(`âœ… æˆåŠŸè¯»å–ç›®æ ‡é¡µé¢ï¼Œé•¿åº¦: ${targetPageContent.length} å­—ç¬¦`);
                    
                    // ä»é¡µé¢ä¸­æå– import çš„ç»„ä»¶
                    const importMatches = targetPageContent.match(/from\s+['"]@\/components\/([^'"]+)['"]/g) || [];
                    const importedComponents = importMatches.map(m => {
                      const match = m.match(/from\s+['"]@\/components\/([^'"]+)['"]/);
                      if (match) {
                        const compPath = match[1];
                        return "frontend/components/" + compPath + (compPath.endsWith('.tsx') ? '' : '.tsx');
                      }
                      return null;
                    }).filter(Boolean);
                    
                    // åˆå¹¶åˆ†æå‡ºçš„ç»„ä»¶å’Œ import çš„ç»„ä»¶
                    const allComponents = [...new Set([
                      ...(codeAnalysisResult.target_components || []),
                      ...importedComponents
                    ])];
                    
                    // è¯»å–ç»„ä»¶å†…å®¹
                    for (const compPath of allComponents.slice(0, 10)) { // æœ€å¤šè¯»å–10ä¸ª
                      try {
                        const fullPath = path.join(process.cwd(), compPath);
                        if (fs.existsSync(fullPath)) {
                          const content = fs.readFileSync(fullPath, "utf8");
                          targetComponentsContent[compPath] = content;
                          console.log(`âœ… è¯»å–ç»„ä»¶: ${compPath} (${content.length} å­—ç¬¦)`);
                        }
                      } catch (e) {
                        // å¿½ç•¥è¯»å–å¤±è´¥
                      }
                    }
                  } else {
                    console.log(`âš ï¸ ç›®æ ‡é¡µé¢ä¸å­˜åœ¨: ${codeAnalysisResult.target_page}`);
                  }
                } catch (e) {
                  console.error(`âŒ è¯»å–ç›®æ ‡é¡µé¢å¤±è´¥:`, e.message);
                }
              }

              // 2.5 Post analysis and todolist comment
              // æ„å»º API ç«¯ç‚¹å±•ç¤º
              let apiEndpointsDisplay = "";
              if (codeAnalysisResult.api_endpoints?.length > 0) {
                apiEndpointsDisplay = [
                  "",
                  "### ğŸ”Œ åç«¯æ¥å£åˆ†æ",
                  "",
                  "| æ–¹æ³• | è·¯å¾„ | æè¿° |",
                  "|------|------|------|",
                  ...codeAnalysisResult.api_endpoints.map(api => 
                    `| \`${api.method}\` | \`${api.path}\` | ${api.description || '-'} |`
                  ),
                  ""
                ].join("\n");
              }
              
              // æ„å»ºæ•°æ®ç±»å‹å±•ç¤º
              let dataTypesDisplay = "";
              if (codeAnalysisResult.data_types?.length > 0) {
                dataTypesDisplay = [
                  "",
                  "### ğŸ“¦ æ•°æ®ç±»å‹",
                  "",
                  codeAnalysisResult.data_types.map(dt => `- \`${dt.name}\``).join("\n"),
                  ""
                ].join("\n");
              }
              
              // æ„å»ºæ–‡ä»¶å˜æ›´è®¡åˆ’å±•ç¤º
              let filesChangeDisplay = "";
              if (codeAnalysisResult.files_to_create?.length > 0 || codeAnalysisResult.files_to_modify?.length > 0) {
                filesChangeDisplay = [
                  "",
                  "### ğŸ“ æ–‡ä»¶å˜æ›´è®¡åˆ’",
                  "",
                  codeAnalysisResult.files_to_create?.length > 0 ? [
                    "**ğŸ†• æ–°å»ºæ–‡ä»¶:**",
                    ...codeAnalysisResult.files_to_create.map(f => `- \`${f}\``)
                  ].join("\n") : "",
                  codeAnalysisResult.files_to_modify?.length > 0 ? [
                    "**âœï¸ ä¿®æ”¹æ–‡ä»¶:**",
                    ...codeAnalysisResult.files_to_modify.map(f => `- \`${f}\``)
                  ].join("\n") : "",
                  ""
                ].filter(Boolean).join("\n");
              }
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "ğŸ“‹ **éœ€æ±‚åˆ†æå®Œæˆ**",
                  "",
                  `**å¤„ç†çš„è§„æ ¼ (${uiSpecs.length} ä¸ª):**`,
                  commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                  "",
                  userInstructions ? `**ç”¨æˆ·é¢å¤–æŒ‡ä»¤:**\n${userInstructions}\n` : "",
                  "### éœ€æ±‚åˆ†æ",
                  analysisResult.analysis || "æ­£åœ¨åˆ†æéœ€æ±‚...",
                  "",
                  "### ğŸ” å·¥ç¨‹åˆ†æï¼ˆåŸºäºé¡¹ç›®å†å²ï¼‰",
                  `- **è§„æ ¼ç±»å‹**: ${codeAnalysisResult.spec_types?.map(t => t === 'ui_design' ? 'ğŸ¨ UIè®¾è®¡' : t === 'backend_api' ? 'ğŸ”Œ åç«¯æ¥å£' : t).join(", ") || "UIè®¾è®¡"}`,
                  `- **æ“ä½œç±»å‹**: ${codeAnalysisResult.operation_type}`,
                  `- **é¡µé¢ç±»å‹**: ${codeAnalysisResult.page_type}`,
                  `- **ç›®æ ‡é¡µé¢**: \`${codeAnalysisResult.target_page}\` ${codeAnalysisResult.target_page_is_new ? "(ğŸ†• æ–°å»º)" : "(âœï¸ å·²å­˜åœ¨)"}`,
                  `- **æ¶‰åŠç»„ä»¶**: ${codeAnalysisResult.target_components?.length > 0 ? codeAnalysisResult.target_components.map(c => `\`${c}\``).join(", ") : "æ— "}`,
                  codeAnalysisResult.change_scope ? `- **ä¿®æ”¹èŒƒå›´**: ${codeAnalysisResult.change_scope}` : "",
                  codeAnalysisResult.preserve_list?.length > 0 ? `- **ä¿ç•™åŠŸèƒ½**: ${codeAnalysisResult.preserve_list.join(", ")}` : "",
                  filesChangeDisplay,
                  apiEndpointsDisplay,
                  dataTypesDisplay,
                  "### ğŸ“ å¾…åŠæ¸…å•",
                  analysisResult.todolist.map((item, idx) => `- [ ] ${item}`).join("\n"),
                  "",
                  "â³ å¼€å§‹ç”Ÿæˆä»£ç ..."
                ].join("\n")
              });

              // 3. Read frontend system files for project constraints
              // Read system files list from ARCHITECTURE.md
              const architectureDocPath = path.join(process.cwd(), "frontend/ARCHITECTURE.md");
              let frontendSystemFiles = [];
              
              if (fs.existsSync(architectureDocPath)) {
                const architectureDoc = fs.readFileSync(architectureDocPath, "utf8");
                // Extract system files list from markdown code block between markers
                const startMarker = "<!-- AGENT_SYSTEM_FILES_START -->";
                const endMarker = "<!-- AGENT_SYSTEM_FILES_END -->";
                const startIdx = architectureDoc.indexOf(startMarker);
                const endIdx = architectureDoc.indexOf(endMarker);
                
                if (startIdx !== -1 && endIdx !== -1) {
                  const filesSection = architectureDoc.substring(startIdx + startMarker.length, endIdx);
                  // Extract file paths from code block (lines starting with frontend/)
                  const fileLines = filesSection.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.startsWith('frontend/') && !line.startsWith('```'));
                  
                  frontendSystemFiles = fileLines;
                  console.log(`ğŸ“– ä» ARCHITECTURE.md è¯»å–åˆ° ${frontendSystemFiles.length} ä¸ªç³»ç»Ÿæ–‡ä»¶`);
                } else {
                  console.log("âš ï¸  ARCHITECTURE.md ä¸­æœªæ‰¾åˆ°ç³»ç»Ÿæ–‡ä»¶æ ‡è®°ï¼Œä½¿ç”¨é»˜è®¤åˆ—è¡¨");
                  // Fallback to default list
                  frontendSystemFiles = [
                    "frontend/package.json",
                    "frontend/tsconfig.json",
                    "frontend/components.json",
                    "frontend/app/layout.tsx",
                    "frontend/app/globals.css",
                    "frontend/STYLE_GUIDE.md",
                    "frontend/lib/utils.ts"
                  ];
                }
              } else {
                console.log("âš ï¸  ARCHITECTURE.md ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤ç³»ç»Ÿæ–‡ä»¶åˆ—è¡¨");
                  // Fallback to default list
                  frontendSystemFiles = [
                    "frontend/package.json",
                    "frontend/tsconfig.json",
                    "frontend/components.json",
                    "frontend/app/layout.tsx",
                    "frontend/app/globals.css",
                    "frontend/STYLE_GUIDE.md",
                    "frontend/lib/utils.ts"
                  ];
              }

              // 3.1 Read system files content
              const projectContext = {};
              const readFiles = [];

              for (const filePath of frontendSystemFiles) {
                try {
                  const fullPath = path.join(process.cwd(), filePath);
                  if (fs.existsSync(fullPath)) {
                    const content = fs.readFileSync(fullPath, "utf8");
                    projectContext[filePath] = content;
                    readFiles.push(filePath);
                    console.log(`âœ… è¯»å–ç³»ç»Ÿæ–‡ä»¶: ${filePath} (${content.length} å­—ç¬¦)`);
                  } else {
                    console.log(`âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: ${filePath}`);
                  }
                } catch (error) {
                  console.error(`âŒ è¯»å–æ–‡ä»¶å¤±è´¥ ${filePath}:`, error.message);
                }
              }

              console.log(`ğŸ“š å…±è¯»å– ${readFiles.length} ä¸ªç³»ç»Ÿæ–‡ä»¶ä½œä¸ºé¡¹ç›®çº¦æŸ`);
              console.log("");

              // 3.2 è¯»å– STYLE_GUIDE.md ä½œä¸ºè®¾è®¡è§„èŒƒ
              let styleGuideContent = '';
              const styleGuidePath = path.join(process.cwd(), "frontend/STYLE_GUIDE.md");
              if (fs.existsSync(styleGuidePath)) {
                styleGuideContent = fs.readFileSync(styleGuidePath, "utf8");
                console.log(`âœ… è¯»å–æ ·å¼æŒ‡å—: frontend/STYLE_GUIDE.md (${styleGuideContent.length} å­—ç¬¦)`);
              } else {
                console.log(`âš ï¸  æ ·å¼æŒ‡å—ä¸å­˜åœ¨: frontend/STYLE_GUIDE.md`);
              }

              // 3.3 è¯»å–ç°æœ‰ä¸šåŠ¡ç»„ä»¶ï¼ˆå…³é”®ï¼è®© Agent çŸ¥é“ç°æœ‰ç»„ä»¶çš„å¯¼å‡ºæ–¹å¼ï¼‰
              console.log("ğŸ“¦ è¯»å–ç°æœ‰ä¸šåŠ¡ç»„ä»¶...");
              const existingComponents = {};
              
              // é€’å½’è¯»å–ç›®å½•ä¸‹æ‰€æœ‰ .tsx æ–‡ä»¶çš„è¾…åŠ©å‡½æ•°
              function readDirRecursive(dir, baseDir = '') {
                const files = [];
                if (!fs.existsSync(dir)) return files;
                
                const entries = fs.readdirSync(dir, { withFileTypes: true });
                for (const entry of entries) {
                  const relativePath = baseDir ? `${baseDir}/${entry.name}` : entry.name;
                  if (entry.isDirectory()) {
                    // è·³è¿‡ ui ç›®å½•ï¼ˆshadcn/ui æ˜¯åªè¯»çš„ï¼‰
                    if (entry.name !== 'ui') {
                      files.push(...readDirRecursive(path.join(dir, entry.name), relativePath));
                    }
                  } else if (entry.name.endsWith('.tsx') || entry.name.endsWith('.ts')) {
                    files.push(relativePath);
                  }
                }
                return files;
              }
              
              // è¯»å– components ç›®å½•ä¸‹æ‰€æœ‰ä¸šåŠ¡ç»„ä»¶ï¼ˆæ’é™¤ ui ç›®å½•ï¼‰
              const componentsDir = path.join(process.cwd(), "frontend/components");
              const componentFiles = readDirRecursive(componentsDir)
                .map(f => `frontend/components/${f}`);
              
              // è¯»å– app ç›®å½•ä¸‹çš„é¡µé¢æ–‡ä»¶
              const appDir = path.join(process.cwd(), "frontend/app");
              const pageFiles = readDirRecursive(appDir)
                .filter(f => f.endsWith('page.tsx') || f.endsWith('layout.tsx'))
                .map(f => `frontend/app/${f}`);
              
              // è¯»å– lib ç›®å½•ä¸‹çš„å·¥å…·æ–‡ä»¶
              const libDir = path.join(process.cwd(), "frontend/lib");
              const libFiles = readDirRecursive(libDir)
                .map(f => `frontend/lib/${f}`);
              
              // è¯»å– types ç›®å½•
              const typesDir = path.join(process.cwd(), "frontend/types");
              const typeFiles = readDirRecursive(typesDir)
                .map(f => `frontend/types/${f}`);
              
              // åˆå¹¶æ‰€æœ‰æ–‡ä»¶è·¯å¾„
              const allBusinessFiles = [...componentFiles, ...pageFiles, ...libFiles, ...typeFiles];
              console.log(`ğŸ“¦ å‘ç° ${allBusinessFiles.length} ä¸ªä¸šåŠ¡æ–‡ä»¶`);
              
              // è¯»å–æ‰€æœ‰æ–‡ä»¶å†…å®¹
              for (const filePath of allBusinessFiles) {
                try {
                  const fullPath = path.join(process.cwd(), filePath);
                  if (fs.existsSync(fullPath)) {
                    const content = fs.readFileSync(fullPath, "utf8");
                    // é™åˆ¶å•ä¸ªæ–‡ä»¶å¤§å°ï¼ˆé¿å… token è¿‡å¤šï¼‰
                    if (content.length < 15000) {
                      existingComponents[filePath] = content;
                      console.log(`âœ… è¯»å–: ${filePath} (${content.length} å­—ç¬¦)`);
                    } else {
                      // å¤§æ–‡ä»¶åªè¯»å–å‰ 5000 å­—ç¬¦ + å¯¼å‡ºè¯­å¥
                      const exportLines = content.split('\n')
                        .filter(line => line.includes('export '))
                        .join('\n');
                      existingComponents[filePath] = content.substring(0, 5000) + 
                        '\n\n// ... æ–‡ä»¶è¿‡å¤§å·²æˆªæ–­ ...\n\n// å¯¼å‡ºè¯­å¥:\n' + exportLines;
                      console.log(`âš ï¸ è¯»å–ï¼ˆå·²æˆªæ–­ï¼‰: ${filePath}`);
                    }
                  }
                } catch (error) {
                  // å¿½ç•¥è¯»å–å¤±è´¥çš„æ–‡ä»¶
                }
              }
              
              console.log(`ğŸ“¦ å…±è¯»å– ${Object.keys(existingComponents).length} ä¸ªä¸šåŠ¡æ–‡ä»¶`);

              // 3.4 Format project context (åŒ…å«ç³»ç»Ÿæ–‡ä»¶)
              const projectContextText = Object.entries(projectContext)
                .map(([filePath, content]) => {
                  const ext = filePath.split('.').pop();
                  const lang = ext === 'tsx' || ext === 'ts' ? 'typescript' : ext === 'json' ? 'json' : ext === 'css' ? 'css' : 'text';
                  return `## ${filePath}\n\`\`\`${lang}\n${content}\n\`\`\``;
                })
                .join("\n\n");
              
              // 3.5 Format existing components context (å…³é”®ï¼)
              const existingComponentsText = Object.entries(existingComponents)
                .map(([filePath, content]) => {
                  // æ£€æµ‹å¯¼å‡ºæ–¹å¼
                  const hasDefaultExport = content.includes('export default');
                  const exportInfo = hasDefaultExport 
                    ? '// âš ï¸ æ­¤æ–‡ä»¶ä½¿ç”¨ DEFAULT EXPORTï¼Œå¯¼å…¥æ—¶è¯·ä½¿ç”¨: import ComponentName from "..."' 
                    : '// âš ï¸ æ­¤æ–‡ä»¶ä½¿ç”¨ NAMED EXPORTï¼Œå¯¼å…¥æ—¶è¯·ä½¿ç”¨: import { ComponentName } from "..."';
                  return `## ${filePath}\n${exportInfo}\n\`\`\`typescript\n${content}\n\`\`\``;
                })
                .join("\n\n");

              // 4. Create new branch
              const branchName = `agent-fe-${issue_number}-${Date.now()}`;
              execSync(`git checkout -b ${branchName}`);

              // 5. Build system prompt and user prompt from external files
              const systemPromptPath = path.join(process.cwd(), ".github/prompts/fe/system-prompt.md");
              const userPromptPath = path.join(process.cwd(), ".github/prompts/fe/user-prompt.md");
              
              let systemPrompt = "";
              let userPromptTemplate = "";
              
              if (fs.existsSync(systemPromptPath)) {
                systemPrompt = fs.readFileSync(systemPromptPath, "utf8");
                console.log(`âœ… è¯»å– system prompt: ${systemPrompt.length} å­—ç¬¦`);
              } else {
                console.log("âš ï¸  system-prompt.md ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©º system prompt");
              }
              
              if (fs.existsSync(userPromptPath)) {
                userPromptTemplate = fs.readFileSync(userPromptPath, "utf8");
                console.log(`âœ… è¯»å– user prompt template: ${userPromptTemplate.length} å­—ç¬¦`);
              } else {
                console.error("âŒ user-prompt.md ä¸å­˜åœ¨");
                throw new Error("user-prompt.md not found");
              }
              
              // Build dynamic sections
              const uiSpecCountText = uiSpecs.length > 1 ? ` (${uiSpecs.length} UI Specs)` : '';
              const commentUrlsText = commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n");
              const userInstructionsSection = userInstructions 
                ? `====================\nUSER INSTRUCTIONS\n====================\n${userInstructions}` 
                : "";
              const todoListSection = analysisResult.todolist.length > 0 
                ? `====================\nTODO LIST (å‚è€ƒ)\n====================\n${analysisResult.todolist.map((item, idx) => `${idx + 1}. ${item}`).join("\n")}` 
                : "";
              
              // æ„å»ºç°æœ‰ä»£ç ä¸Šä¸‹æ–‡ï¼ˆå…³é”®ï¼åŒ…å«å¯¼å‡ºæ–¹å¼æç¤ºï¼‰
              const existingCodeSection = existingComponentsText 
                ? `\n\n====================\nğŸ“¦ ç°æœ‰ä¸šåŠ¡ä»£ç ï¼ˆå¿…é¡»å‚è€ƒå¯¼å‡ºæ–¹å¼ï¼ï¼‰\n====================\n\nâš ï¸ **é‡è¦**ï¼šä»¥ä¸‹æ˜¯é¡¹ç›®ä¸­ç°æœ‰çš„ä¸šåŠ¡ä»£ç ã€‚\n- ä¿®æ”¹æˆ–å¯¼å…¥è¿™äº›æ–‡ä»¶æ—¶ï¼Œå¿…é¡»ä½¿ç”¨æ­£ç¡®çš„å¯¼å…¥è¯­æ³•\n- æ¯ä¸ªæ–‡ä»¶å¼€å¤´çš„æ³¨é‡Šè¯´æ˜äº†å®ƒä½¿ç”¨çš„æ˜¯ DEFAULT EXPORT è¿˜æ˜¯ NAMED EXPORT\n\n${existingComponentsText}`
                : "";
              
              // æ„å»ºä»£ç åˆ†æä¸Šä¸‹æ–‡
              const operationTypeMap = {
                "new_page": "ğŸ†• åˆ›å»ºæ–°é¡µé¢",
                "add_feature": "â• æ–°å¢åŠŸèƒ½ - åœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šæ·»åŠ ï¼Œç°æœ‰åŠŸèƒ½å¿…é¡»ä¿æŒæ­£å¸¸",
                "fix_bug": "ğŸ› ä¿®å¤Bug - åªä¿®æ”¹æœ‰é—®é¢˜çš„ä»£ç ï¼Œå…¶ä»–ä¿æŒä¸å˜",
                "refactor": "ğŸ”§ é‡æ„ - ä¼˜åŒ–ä»£ç ç»“æ„ï¼ŒåŠŸèƒ½å¿…é¡»ä¿æŒå®Œå…¨ä¸€è‡´",
                "style_change": "ğŸ¨ æ ·å¼è°ƒæ•´ - åªä¿®æ”¹UI/æ ·å¼ï¼Œä¸æ”¹åŠ¨ä»»ä½•é€»è¾‘",
                "remove_feature": "ğŸ—‘ï¸ ç§»é™¤åŠŸèƒ½ - åˆ é™¤æŒ‡å®šåŠŸèƒ½ï¼Œå…¶ä»–ä¿æŒä¸å˜"
              };
              
              // æ„å»º API ç«¯ç‚¹ä¸Šä¸‹æ–‡
              let apiEndpointsContext = "";
              if (codeAnalysisResult.api_endpoints?.length > 0) {
                apiEndpointsContext = [
                  "",
                  "## ğŸ”Œ åç«¯ API ç«¯ç‚¹ï¼ˆéœ€è¦è°ƒç”¨çš„æ¥å£ï¼‰",
                  "",
                  ...codeAnalysisResult.api_endpoints.map(api => [
                    `### ${api.method} ${api.path}`,
                    api.description ? `æè¿°: ${api.description}` : "",
                    api.request_params ? `è¯·æ±‚å‚æ•°: \`${JSON.stringify(api.request_params)}\`` : "",
                    api.response_format ? `å“åº”æ ¼å¼: \`${JSON.stringify(api.response_format)}\`` : "",
                    ""
                  ].filter(Boolean).join("\n")),
                  ""
                ].join("\n");
              }
              
              // æ„å»ºæ•°æ®ç±»å‹ä¸Šä¸‹æ–‡
              let dataTypesContext = "";
              if (codeAnalysisResult.data_types?.length > 0) {
                dataTypesContext = [
                  "",
                  "## ğŸ“¦ éœ€è¦å®šä¹‰çš„ TypeScript ç±»å‹",
                  "",
                  "```typescript",
                  ...codeAnalysisResult.data_types.map(dt => {
                    const fields = dt.fields ? Object.entries(dt.fields).map(([k, v]) => `  ${k}: ${v};`).join("\n") : "";
                    return `interface ${dt.name} {\n${fields}\n}`;
                  }),
                  "```",
                  "",
                  "**æ³¨æ„**: å°†è¿™äº›ç±»å‹å®šä¹‰æ”¾åœ¨ `frontend/types/` ç›®å½•ä¸‹ï¼Œæˆ–è€…åœ¨ç»„ä»¶æ–‡ä»¶ä¸­å®šä¹‰ã€‚",
                  ""
                ].join("\n");
              }
              
              // æ„å»ºæ–‡ä»¶å˜æ›´è®¡åˆ’ä¸Šä¸‹æ–‡
              let filesChangeContext = "";
              if (codeAnalysisResult.files_to_create?.length > 0 || codeAnalysisResult.files_to_modify?.length > 0) {
                filesChangeContext = [
                  "",
                  "## ğŸ“ æ–‡ä»¶å˜æ›´è®¡åˆ’ï¼ˆåŸºäºé¡¹ç›®å†å²åˆ†æï¼‰",
                  "",
                  codeAnalysisResult.files_to_create?.length > 0 ? [
                    "### ğŸ†• éœ€è¦æ–°å»ºçš„æ–‡ä»¶ï¼ˆå®Œæ•´ç¼–å†™ï¼‰",
                    ...codeAnalysisResult.files_to_create.map(f => `- ${f}`),
                    ""
                  ].join("\n") : "",
                  codeAnalysisResult.files_to_modify?.length > 0 ? [
                    "### âœï¸ éœ€è¦ä¿®æ”¹çš„å·²æœ‰æ–‡ä»¶ï¼ˆå¢é‡ä¿®æ”¹ï¼‰",
                    "**é‡è¦**ï¼šè¿™äº›æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œä½ éœ€è¦ä¿ç•™ç°æœ‰ä»£ç çš„åŠŸèƒ½ï¼Œåªåšå¢é‡ä¿®æ”¹ï¼",
                    ...codeAnalysisResult.files_to_modify.map(f => `- ${f}`),
                    ""
                  ].join("\n") : "",
                  ""
                ].filter(Boolean).join("\n");
              }
              
              let codeAnalysisSection = [
                "",
                "====================",
                "ğŸ” ä»£ç åˆ†æç»“æœï¼ˆåŸºäºé¡¹ç›®å†å²ï¼Œå†³å®šä½ çš„ä¿®æ”¹ç­–ç•¥ï¼‰",
                "====================",
                "",
                `**è§„æ ¼ç±»å‹**: ${codeAnalysisResult.spec_types?.map(t => t === 'ui_design' ? 'ğŸ¨ UIè®¾è®¡' : t === 'backend_api' ? 'ğŸ”Œ åç«¯æ¥å£' : t).join(", ") || "UIè®¾è®¡"}`,
                `**æ“ä½œç±»å‹**: ${operationTypeMap[codeAnalysisResult.operation_type] || codeAnalysisResult.operation_type}`,
                `**é¡µé¢ç±»å‹**: ${codeAnalysisResult.page_type === "new_page" ? "æ–°é¡µé¢" : "ç°æœ‰é¡µé¢ä¿®æ”¹"}`,
                `**ç›®æ ‡é¡µé¢**: ${codeAnalysisResult.target_page} ${codeAnalysisResult.target_page_is_new ? "(ğŸ†• æ–°å»º)" : "(âœï¸ å·²å­˜åœ¨ï¼Œéœ€ä¿ç•™ç°æœ‰åŠŸèƒ½)"}`,
                codeAnalysisResult.target_components?.length > 0 ? `**æ¶‰åŠç»„ä»¶**: ${codeAnalysisResult.target_components.join(", ")}` : "",
                codeAnalysisResult.change_scope ? `**ä¿®æ”¹èŒƒå›´**: ${codeAnalysisResult.change_scope}` : "",
                codeAnalysisResult.preserve_list?.length > 0 ? `**å¿…é¡»ä¿ç•™çš„åŠŸèƒ½**: ${codeAnalysisResult.preserve_list.map(p => "- " + p).join("\n")}` : "",
                filesChangeContext,
                apiEndpointsContext,
                dataTypesContext,
                ""
              ].filter(Boolean).join("\n");
              
              // æ„å»ºç›®æ ‡é¡µé¢ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœè¯»å–äº†ç›®æ ‡é¡µé¢ï¼‰
              let targetPageSection = "";
              if (targetPageContent) {
                targetPageSection = [
                  "",
                  "====================",
                  "ğŸ¯ ç›®æ ‡é¡µé¢ä»£ç ï¼ˆè¿™æ˜¯ä½ è¦ä¿®æ”¹çš„é¡µé¢ï¼‰",
                  "====================",
                  "",
                  `æ–‡ä»¶: ${codeAnalysisResult.target_page}`,
                  "",
                  "```tsx",
                  targetPageContent.substring(0, 15000),
                  targetPageContent.length > 15000 ? "\n// ... ä»£ç è¿‡é•¿å·²æˆªæ–­ ..." : "",
                  "```",
                  ""
                ].join("\n");
              }
              
              // æ„å»ºç›®æ ‡ç»„ä»¶ä¸Šä¸‹æ–‡
              let targetComponentsSection = "";
              if (Object.keys(targetComponentsContent).length > 0) {
                targetComponentsSection = [
                  "",
                  "====================",
                  "ğŸ“¦ ç›¸å…³ç»„ä»¶ä»£ç ï¼ˆé¡µé¢å¼•ç”¨çš„ç»„ä»¶ï¼‰",
                  "====================",
                  ""
                ].join("\n");
                
                for (const [compPath, content] of Object.entries(targetComponentsContent)) {
                  const hasDefaultExport = content.includes('export default');
                  const exportInfo = hasDefaultExport 
                    ? '// âš ï¸ DEFAULT EXPORT - import ComponentName from "..."' 
                    : '// âš ï¸ NAMED EXPORT - import { ComponentName } from "..."';
                  targetComponentsSection += `\n### ${compPath}\n${exportInfo}\n\`\`\`tsx\n${content.substring(0, 8000)}${content.length > 8000 ? "\n// ... ä»£ç è¿‡é•¿å·²æˆªæ–­ ..." : ""}\n\`\`\`\n`;
                }
              }
              
              // ç»„åˆå®Œæ•´çš„é¡¹ç›®ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«ä»£ç åˆ†æå’Œç›®æ ‡ä»£ç ï¼‰
              const fullProjectContext = [
                projectContextText,
                existingCodeSection,
                codeAnalysisSection,
                targetPageSection,
                targetComponentsSection
              ].filter(Boolean).join("\n");
              
              // Substitute template variables
              const userPrompt = userPromptTemplate
                .replace("{{PROJECT_CONTEXT}}", fullProjectContext)
                .replace("{{STYLE_GUIDE_CONTENT}}", styleGuideContent || 'æœªæ‰¾åˆ° STYLE_GUIDE.md æ–‡ä»¶')
                .replace("{{UI_SPEC_COUNT}}", uiSpecCountText)
                .replace("{{COMMENT_URLS}}", commentUrlsText)
                .replace("{{COMBINED_UI_SPEC}}", combinedUISpec)
                .replace("{{USER_INSTRUCTIONS_SECTION}}", userInstructionsSection)
                .replace("{{TODO_LIST_SECTION}}", todoListSection);
              
              console.log(`âœ… æ„å»ºå®Œæˆ user prompt: ${userPrompt.length} å­—ç¬¦`);
              console.log(`   - ç³»ç»Ÿæ–‡ä»¶: ${Object.keys(projectContext).length} ä¸ª`);
              console.log(`   - ä¸šåŠ¡æ–‡ä»¶: ${Object.keys(existingComponents).length} ä¸ª`);
              console.log(`   - ç›®æ ‡é¡µé¢: ${targetPageContent ? "å·²è¯»å–" : "æ— "}`);
              console.log(`   - ç›®æ ‡ç»„ä»¶: ${Object.keys(targetComponentsContent).length} ä¸ª`);

              // 5. Call model
              const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                  ],
                  temperature: 0.3,
                  max_tokens: 640000
                })
              });

              const data = await res.json();
              const raw = data.choices?.[0]?.message?.content;

              if (!raw) {
                console.error("âŒ Model returned empty response.");
                console.error("Response data:", JSON.stringify(data, null, 2));
                throw new Error("Model returned empty response.");
              }

              console.log("ğŸ“ Model raw response length:", raw.length);
              console.log("ğŸ“ Model raw response preview (first 500 chars):");
              console.log("-".repeat(80));
              console.log(raw.substring(0, 500));
              console.log("-".repeat(80));

              // 5.1 Extract JSON from possible markdown code block or find JSON object
              let jsonStr = raw.trim();
              
              console.log("ğŸ“ Model raw response length:", raw.length);
              console.log("ğŸ“ Model raw response preview (first 1000 chars):");
              console.log("-".repeat(80));
              console.log(raw.substring(0, 1000));
              console.log("-".repeat(80));
              
              // Try to extract from markdown code block first
              const jsonMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
              if (jsonMatch) {
                jsonStr = jsonMatch[1].trim();
                console.log("âœ… Extracted JSON from markdown code block");
              } else {
                // Try to find JSON object by finding first { and last }
                const firstBrace = jsonStr.indexOf('{');
                const lastBrace = jsonStr.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                  jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                  console.log("âœ… Extracted JSON object from text");
                } else {
                  console.log("âš ï¸  No JSON structure found, using raw content");
                }
              }

              console.log("ğŸ“„ JSON string length:", jsonStr.length);
              console.log("ğŸ“„ JSON string preview (first 1000 chars):");
              console.log("-".repeat(80));
              console.log(jsonStr.substring(0, 1000));
              console.log("-".repeat(80));
              console.log("ğŸ“„ JSON string preview (last 500 chars):");
              console.log("-".repeat(80));
              console.log(jsonStr.substring(Math.max(0, jsonStr.length - 500)));
              console.log("-".repeat(80));

              let parsed;
              try {
                parsed = JSON.parse(jsonStr);
                console.log("âœ… JSON parsed successfully");
                console.log(`ğŸ“¦ Parsed object has ${parsed.files?.length || 0} files`);
              } catch (parseError) {
                console.error("âŒ JSON parse error:", parseError.message);
                console.error("âŒ Error position:", parseError.message.match(/position (\d+)/)?.[1] || "unknown");
                console.error("âŒ JSON string (full, length:", jsonStr.length, "chars):");
                console.error("-".repeat(80));
                console.error(jsonStr);
                console.error("-".repeat(80));
                
                // Try to fix common JSON issues
                let fixedJson = jsonStr;
                let fixed = false;
                
                // Fix 1: Remove trailing commas before } or ]
                fixedJson = fixedJson.replace(/,(\s*[}\]])/g, '$1');
                if (fixedJson !== jsonStr) {
                  fixed = true;
                  console.log("ğŸ”§ Attempted fix: Removed trailing commas");
                }
                
                // Fix 2: Handle truncated JSON (incomplete content)
                // Check if JSON was truncated mid-string
                const lastQuote = fixedJson.lastIndexOf('"');
                const lastBrace = fixedJson.lastIndexOf('}');
                const lastBracket = fixedJson.lastIndexOf(']');
                
                if (lastQuote > lastBrace && lastQuote > lastBracket) {
                  console.log("ğŸ”§ Detected truncated JSON, attempting to fix...");
                  // Find the last complete file entry
                  const filesMatch = fixedJson.match(/"files"\s*:\s*\[/);
                  if (filesMatch) {
                    // Find all complete file objects
                    const completeFiles = [];
                    const filePattern = /\{\s*"path"\s*:\s*"([^"]+)"\s*,\s*"content"\s*:\s*"((?:[^"\\]|\\.)*)"\s*\}/g;
                    let match;
                    while ((match = filePattern.exec(fixedJson)) !== null) {
                      completeFiles.push({
                        path: match[1],
                        content: match[2].replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\')
                      });
                    }
                    
                    if (completeFiles.length > 0) {
                      console.log(`ğŸ”§ Recovered ${completeFiles.length} complete files from truncated JSON`);
                      parsed = { files: completeFiles };
                      fixed = true;
                    }
                  }
                }
                
                // Try parsing fixed JSON if not already recovered
                if (!parsed && fixed) {
                  try {
                    parsed = JSON.parse(fixedJson);
                    console.log("âœ… Fixed JSON parsed successfully");
                    console.log(`ğŸ“¦ Parsed object has ${parsed.files?.length || 0} files`);
                  } catch (fixError) {
                    console.error("âŒ Fixed JSON still invalid:", fixError.message);
                  }
                }
                
                if (!parsed) {
                  // Last resort: try to extract any complete file objects
                  console.log("ğŸ”§ Last resort: extracting individual file objects...");
                  const filePattern = /\{\s*"path"\s*:\s*"([^"]+)"\s*,\s*"content"\s*:\s*"((?:[^"\\]|\\.)*)"\s*\}/g;
                  const recoveredFiles = [];
                  let match;
                  while ((match = filePattern.exec(jsonStr)) !== null) {
                    try {
                      recoveredFiles.push({
                        path: match[1],
                        content: match[2].replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\')
                      });
                    } catch (e) {
                      console.log(`âš ï¸ Failed to parse file: ${match[1]}`);
                    }
                  }
                  
                  if (recoveredFiles.length > 0) {
                    console.log(`ğŸ”§ Recovered ${recoveredFiles.length} files from malformed JSON`);
                    parsed = { files: recoveredFiles };
                  } else {
                    throw new Error(`Model output is not valid JSON: ${parseError.message}. Could not recover any files.`);
                  }
                }
              }

              // 6. Write files with path validation
              const generatedFiles = [];
              const fileChanges = {
                created: [],
                modified: [],
                errors: []
              };
              
              for (const file of parsed.files) {
                // 6.1 Validate path - STRICT: ONLY frontend/ directory allowed
                let normalizedPath = file.path.trim();
                
                // Remove leading slash if present
                if (normalizedPath.startsWith("/")) {
                  normalizedPath = normalizedPath.substring(1);
                }
                
                // STRICT CHECK: Path MUST start with "frontend/" - NO AUTO-FIX
                if (!normalizedPath.startsWith("frontend/")) {
                  fileChanges.errors.push(`è·¯å¾„è¢«æ‹’ç»: ${file.path} - åªå…è®¸åœ¨ frontend/ ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶`);
                  continue;
                }
                
                // CRITICAL: FORBIDDEN PATH - components/ui/ directory is READ-ONLY
                // shadcn/ui components MUST NOT be modified, only imported and used
                if (normalizedPath.startsWith("frontend/components/ui/")) {
                  fileChanges.errors.push(`è·¯å¾„è¢«æ‹’ç»: ${file.path} - components/ui/ ç›®å½•ä¸‹çš„æ–‡ä»¶æ˜¯åªè¯»çš„ï¼Œç¦æ­¢ä¿®æ”¹ã€‚åªèƒ½ä» @/components/ui/ å¯¼å…¥ä½¿ç”¨ï¼Œä¸èƒ½ä¿®æ”¹æˆ–åˆ›å»ºæ–°æ–‡ä»¶ã€‚`);
                  continue;
                }
                
                // CRITICAL: FORBIDDEN FILE - globals.css is READ-ONLY
                // Global styles are managed by the project maintainers
                if (normalizedPath === "frontend/app/globals.css" || normalizedPath.endsWith("/globals.css")) {
                  fileChanges.errors.push(`è·¯å¾„è¢«æ‹’ç»: ${file.path} - globals.css æ–‡ä»¶æ˜¯åªè¯»çš„ï¼Œç¦æ­¢ä¿®æ”¹ã€‚å¦‚æœéœ€è¦è‡ªå®šä¹‰æ ·å¼ï¼Œè¯·åœ¨ç»„ä»¶ç›®å½•ä¸‹åˆ›å»ºç‹¬ç«‹çš„ CSS æ–‡ä»¶ï¼ˆå¦‚ component.module.css æˆ– component.cssï¼‰ã€‚`);
                  continue;
                }
                
                // FORBIDDEN: demo/ directory - No demo/example pages allowed
                if (normalizedPath.includes("/demo/") || normalizedPath.includes("/example/") || normalizedPath.includes("/sample/")) {
                  fileChanges.errors.push(`è·¯å¾„è¢«æ‹’ç»: ${file.path} - ç¦æ­¢åˆ›å»º demo/example/sample ç›®å½•ã€‚å¿…é¡»ç”ŸæˆçœŸå®å¯ç”¨çš„åŠŸèƒ½ä»£ç ï¼Œè€Œä¸æ˜¯ç¤ºä¾‹é¡µé¢ã€‚`);
                  continue;
                }
                
                // Prevent path traversal attacks (even within frontend/)
                if (normalizedPath.includes("../") || normalizedPath.includes("..\\")) {
                  fileChanges.errors.push(`è·¯å¾„ä¸å®‰å…¨: ${file.path} - ä¸å…è®¸ä½¿ç”¨è·¯å¾„éå†`);
                  continue;
                }
                
                // Additional check: ensure normalized path is still within frontend/
                // This prevents paths like "frontend/../../other-dir/file"
                const pathParts = normalizedPath.split('/');
                if (pathParts[0] !== "frontend" || pathParts.includes("..")) {
                  fileChanges.errors.push(`è·¯å¾„æ— æ•ˆ: ${file.path} - å¿…é¡»åœ¨ frontend/ ç›®å½•å†…`);
                  continue;
                }
                
                const fullPath = path.join(process.cwd(), normalizedPath);
                
                // Check if file already exists
                const fileExists = fs.existsSync(fullPath);
                
                try {
                  fs.mkdirSync(path.dirname(fullPath), { recursive: true });
                  fs.writeFileSync(fullPath, file.content, "utf8");
                  generatedFiles.push(normalizedPath);
                  
                  if (fileExists) {
                    fileChanges.modified.push(normalizedPath);
                  } else {
                    fileChanges.created.push(normalizedPath);
                  }
                } catch (error) {
                  fileChanges.errors.push(`å†™å…¥å¤±è´¥: ${normalizedPath} - ${error.message}`);
                }
              }

              // 6.1 Analyze completion status (before recording changelog)
              const completionPrompt = `è¯·åˆ†æä»¥ä¸‹å†…å®¹ï¼Œå¯¹æ¯”å¾…åŠæ¸…å•å’Œå®é™…å®Œæˆæƒ…å†µã€‚

              å¾…åŠæ¸…å•:
              ${analysisResult.todolist.map((item, idx) => `${idx + 1}. ${item}`).join("\n")}
              
              å®é™…ç”Ÿæˆçš„æ–‡ä»¶:
              ${generatedFiles.map((f, idx) => `${idx + 1}. ${f}`).join("\n")}
              
              è¯·è¿”å› JSON æ ¼å¼:
              {
                "completed": ["å·²å®Œæˆé¡¹1", "å·²å®Œæˆé¡¹2"],
                "notCompleted": ["æœªå®Œæˆé¡¹1", "æœªå®Œæˆé¡¹2"],
                "summary": "å®Œæˆæƒ…å†µæ€»ç»“ï¼ˆ1-2å¥è¯ï¼‰"
              }
              
              åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚`;

              const completionRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [
                    { role: "user", content: completionPrompt }
                  ],
                  temperature: 0.3
                })
              });

              const completionData = await completionRes.json();
              const completionRaw = completionData.choices?.[0]?.message?.content;
              
              let completionStatus = { completed: [], notCompleted: [], summary: "" };
              if (completionRaw) {
                let completionJsonStr = completionRaw.trim();
                const completionJsonMatch = completionJsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (completionJsonMatch) {
                  completionJsonStr = completionJsonMatch[1].trim();
                }
                try {
                  completionStatus = JSON.parse(completionJsonStr);
                } catch (e) {
                  console.error("Failed to parse completion JSON:", e);
                  completionStatus.completed = analysisResult.todolist;
                  completionStatus.summary = "ä»£ç å·²ç”Ÿæˆ";
                }
              }

              // 6.2 Record changes to changelog
              // changelogPath å·²åœ¨ Step 2.2 å®šä¹‰
              const timestamp = new Date().toISOString();
              const changelogEntry = [
                `## ${timestamp} - Issue #${issue_number}`,
                "",
                `**UI Spec${uiSpecs.length > 1 ? 's' : ''} (${uiSpecs.length}):**`,
                commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                userInstructions ? `**ç”¨æˆ·æŒ‡ä»¤:** ${userInstructions}` : "",
                "",
                "### ğŸ“ éœ€æ±‚åˆ†æ",
                analysisResult.analysis || "éœ€æ±‚åˆ†æå®Œæˆ",
                "",
                "### âœ… å·²å®Œæˆ",
                completionStatus.completed.length > 0
                  ? completionStatus.completed.map(item => `- ${item}`).join("\n")
                  : "- ä»£ç å·²ç”Ÿæˆ",
                "",
                completionStatus.notCompleted.length > 0 ? [
                  "### âŒ æœªå®Œæˆ",
                  completionStatus.notCompleted.map(item => `- ${item}`).join("\n"),
                  ""
                ].join("\n") : "",
                "### ğŸ“ æ–‡ä»¶å˜æ›´",
                "",
                `**æ–°å»ºæ–‡ä»¶ (${fileChanges.created.length}):**`,
                fileChanges.created.length > 0
                  ? fileChanges.created.map(f => `- \`${f}\``).join("\n")
                  : "- æ— ",
                "",
                `**ä¿®æ”¹æ–‡ä»¶ (${fileChanges.modified.length}):**`,
                fileChanges.modified.length > 0
                  ? fileChanges.modified.map(f => `- \`${f}\``).join("\n")
                  : "- æ— ",
                "",
                fileChanges.errors.length > 0 ? [
                  `**é”™è¯¯ (${fileChanges.errors.length}):**`,
                  fileChanges.errors.map(e => `- âš ï¸ ${e}`).join("\n"),
                  ""
                ].join("\n") : "",
                "---",
                ""
              ].join("\n");
              
              // Read existing changelog or create new one
              // changelogContent å·²åœ¨ Step 2.2 å®šä¹‰ï¼Œè¿™é‡Œé‡æ–°è¯»å–æœ€æ–°å†…å®¹
              if (fs.existsSync(changelogPath)) {
                changelogContent = fs.readFileSync(changelogPath, "utf8");
              } else {
                changelogContent = [
                  "# Frontend Agent å˜æ›´æ—¥å¿—",
                  "",
                  "æ­¤æ–‡ä»¶ç”± Frontend Agent è‡ªåŠ¨ç”Ÿæˆå’Œç»´æŠ¤ï¼Œè®°å½•æ‰€æœ‰ä»£ç å˜æ›´å†å²ã€‚",
                  "",
                  "---",
                  ""
                ].join("\n");
              }
              
              // Prepend new entry
              const updatedChangelog = changelogEntry + changelogContent;
              fs.writeFileSync(changelogPath, updatedChangelog, "utf8");
              
              // Add changelog to generated files if it's new or modified
              if (!generatedFiles.includes("frontend/AGENT_CHANGELOG.md")) {
                generatedFiles.push("frontend/AGENT_CHANGELOG.md");
                fileChanges.created.push("frontend/AGENT_CHANGELOG.md");
              } else if (!fileChanges.modified.includes("frontend/AGENT_CHANGELOG.md")) {
                fileChanges.modified.push("frontend/AGENT_CHANGELOG.md");
              }

              // 6.3 Update ARCHITECTURE.md - å§‹ç»ˆæ›´æ–°ä»¥åæ˜ æœ€æ–°çš„æ–‡ä»¶ç»“æ„
              console.log("ğŸ“ æ›´æ–° ARCHITECTURE.md...");
              if (fs.existsSync(architectureDocPath)) {
                // Analyze if there are new important system files or directory structure changes
                const newSystemFiles = [];
                const newDirectories = new Set();
                
                // Check ALL generated files (both created and modified)
                const allChangedFiles = [...fileChanges.created, ...fileChanges.modified];
                
                for (const file of allChangedFiles) {
                  // Check if it's a configuration file or important system file
                  const fileName = path.basename(file);
                  const isConfigFile = fileName.includes('config') || 
                                      fileName.includes('package.json') || 
                                      fileName.includes('tsconfig') ||
                                      fileName.includes('tailwind') ||
                                      fileName.includes('middleware') ||
                                      fileName.includes('layout') ||
                                      fileName === 'page.tsx' ||
                                      fileName === 'globals.css' ||
                                      fileName === 'components.json';
                  
                  // Check if it's in a key directory (system-level files)
                  const isKeyDir = file.includes('/lib/api/') ||
                                  file.includes('/lib/utils/') ||
                                  file.includes('/lib/config/') ||
                                  file.includes('/lib/constants/') ||
                                  file.includes('/types/') ||
                                  file.includes('/hooks/');
                  
                  // Check if it's a root-level important file
                  const isRootFile = file === 'frontend/middleware.ts' ||
                                     file === 'frontend/components.json' ||
                                     file === 'frontend/tailwind.config.ts' ||
                                     file === 'frontend/tsconfig.json' ||
                                     file === 'frontend/package.json' ||
                                     file.startsWith('frontend/app/layout') ||
                                     file.startsWith('frontend/app/page') ||
                                     file.startsWith('frontend/app/globals');
                  
                  // å¢åŠ ï¼šä¸šåŠ¡ç»„ä»¶ä¹Ÿä½œä¸ºç³»ç»Ÿæ–‡ä»¶è®°å½•
                  const isBusinessComponent = file.startsWith('frontend/components/') && 
                                              !file.startsWith('frontend/components/ui/');
                  
                  if (isConfigFile || isKeyDir || isRootFile || isBusinessComponent) {
                    newSystemFiles.push(file);
                  }
                  
                  // Track new directories
                  const dirPath = path.dirname(file);
                  if (dirPath !== 'frontend' && dirPath.startsWith('frontend/')) {
                    newDirectories.add(dirPath);
                  }
                }
                
                // å§‹ç»ˆæ›´æ–° ARCHITECTURE.mdï¼ˆå¦‚æœæœ‰ä»»ä½•æ–°æ–‡ä»¶ï¼‰
                if (newSystemFiles.length > 0 || fileChanges.created.length > 0) {
                  console.log(`ğŸ“ æ£€æµ‹åˆ°æ¶æ„å˜åŒ–ï¼Œå‡†å¤‡æ›´æ–° ARCHITECTURE.md`);
                  console.log(`   æ–°ç³»ç»Ÿæ–‡ä»¶: ${newSystemFiles.length} ä¸ª`);
                  console.log(`   æ–°ç›®å½•: ${newDirectories.size} ä¸ª`);
                  
                  // Read current ARCHITECTURE.md
                  let architectureContent = fs.readFileSync(architectureDocPath, "utf8");
                  
                  // Extract current system files list
                  const startMarker = "<!-- AGENT_SYSTEM_FILES_START -->";
                  const endMarker = "<!-- AGENT_SYSTEM_FILES_END -->";
                  const startIdx = architectureContent.indexOf(startMarker);
                  const endIdx = architectureContent.indexOf(endMarker);
                  
                  if (startIdx !== -1 && endIdx !== -1) {
                    // Get current system files
                    const currentFilesSection = architectureContent.substring(startIdx + startMarker.length, endIdx);
                    const currentFiles = currentFilesSection.split('\n')
                      .map(line => line.trim())
                      .filter(line => line.startsWith('frontend/') && !line.startsWith('```'));
                    
                    // Merge with new system files (avoid duplicates)
                    const allSystemFiles = [...new Set([...currentFiles, ...newSystemFiles])].sort();
                    
                    // Update system files list
                    const newFilesSection = `\n\`\`\`\n${allSystemFiles.join('\n')}\n\`\`\`\n`;
                    const updatedArchitecture = 
                      architectureContent.substring(0, startIdx + startMarker.length) +
                      newFilesSection +
                      architectureContent.substring(endIdx);
                    
                    fs.writeFileSync(architectureDocPath, updatedArchitecture, "utf8");
                    console.log(`âœ… å·²æ›´æ–° ARCHITECTURE.md ç³»ç»Ÿæ–‡ä»¶åˆ—è¡¨ï¼ˆå…± ${allSystemFiles.length} ä¸ªæ–‡ä»¶ï¼‰`);
                    
                    // Add to file changes if not already tracked
                    if (!fileChanges.modified.includes("frontend/ARCHITECTURE.md")) {
                      fileChanges.modified.push("frontend/ARCHITECTURE.md");
                    }
                  }
                }
              }

              // 7. Commit changes
              execSync("git add .");
              execSync(`git commit -m "feat: implement frontend from frozen UI spec (#${issue_number})"`);
              execSync(`git push origin ${branchName}`);

              // 8. Create PR
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                title: `Frontend: implement frozen UI spec (#${issue_number})`,
                head: branchName,
                base: "main",
                body: [
                  "This PR was generated by Vibe Frontend Agent.",
                  "",
                  `**UI Spec Source${uiSpecs.length > 1 ? 's' : ''} (${uiSpecs.length}):**`,
                  commentUrls.map(url => `- ${url}`).join("\n"),
                  "",
                  userInstructions ? `**User Instructions:**\n${userInstructions}\n` : "",
                  "### å®Œæˆæƒ…å†µ",
                  completionStatus.summary || "ä»£ç å·²ç”Ÿæˆ",
                  "",
                  "**å·²å®Œæˆ:**",
                  completionStatus.completed.map(item => `- âœ… ${item}`).join("\n") || "- ä»£ç å·²ç”Ÿæˆ",
                  "",
                  completionStatus.notCompleted.length > 0 ? [
                    "**æœªå®Œæˆ:**",
                    completionStatus.notCompleted.map(item => `- âŒ ${item}`).join("\n"),
                    ""
                  ].join("\n") : "",
                  "- UI spec treated as immutable contract",
                  "- No UI inference or redesign",
                  "- Ready for review"
                ].join("\n")
              });

              // 9. Comment back to issue
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "âœ… **Frontend implementation completed**",
                  "",
                  `ğŸ”— PR: ${pr.data.html_url}`,
                  "",
                  `**å¤„ç†çš„ UI Spec (${uiSpecs.length} ä¸ª):**`,
                  commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                  "",
                  "### ğŸ“Š å®Œæˆæƒ…å†µ",
                  completionStatus.summary || "ä»£ç å·²ç”Ÿæˆå¹¶æäº¤",
                  "",
                  "**âœ… å·²å®Œæˆ:**",
                  completionStatus.completed.length > 0 
                    ? completionStatus.completed.map(item => `- ${item}`).join("\n")
                    : "- ä»£ç å·²ç”Ÿæˆ",
                  "",
                  completionStatus.notCompleted.length > 0 ? [
                    "**âŒ æœªå®Œæˆ:**",
                    completionStatus.notCompleted.map(item => `- ${item}`).join("\n"),
                    ""
                  ].join("\n") : "",
                  "**ğŸ“ æ–‡ä»¶å˜æ›´:**",
                  "",
                  `**æ–°å»º (${fileChanges.created.length}):**`,
                  fileChanges.created.length > 0
                    ? fileChanges.created.map(f => `- \`${f}\``).join("\n")
                    : "- æ— ",
                  "",
                  `**ä¿®æ”¹ (${fileChanges.modified.length}):**`,
                  fileChanges.modified.length > 0
                    ? fileChanges.modified.map(f => `- \`${f}\``).join("\n")
                    : "- æ— ",
                  "",
                  fileChanges.errors.length > 0 ? [
                    "**âš ï¸ é”™è¯¯:**",
                    fileChanges.errors.map(e => `- ${e}`).join("\n"),
                    ""
                  ].join("\n") : "",
                  "**ğŸ“ å˜æ›´æ—¥å¿—:**",
                  `æ‰€æœ‰å˜æ›´å·²è®°å½•åˆ° \`frontend/AGENT_CHANGELOG.md\``,
                  "",
                  "**ğŸ“š é¡¹ç›®çº¦æŸ:**",
                  `å·²è¯»å– ${readFiles.length} ä¸ªç³»ç»Ÿæ–‡ä»¶ä½œä¸ºæ¶æ„å‚è€ƒ`,
                  "",
                  "---",
                  "Notes:",
                  "- âœ… ä¸¥æ ¼è·¯å¾„çº¦æŸï¼šæ‰€æœ‰æ–‡ä»¶ä»…åœ¨ `frontend/` ç›®å½•ä¸‹",
                  "- âœ… ç¦æ­¢åœ¨ `frontend/` ç›®å½•å¤–åˆ›å»ºä»»ä½•æ–‡ä»¶",
                  "- âœ… éµå¾ªç°æœ‰é¡¹ç›®æ¶æ„æ¨¡å¼",
                  "- âœ… å˜æ›´å†å²å·²è®°å½•åˆ° `frontend/AGENT_CHANGELOG.md`",
                  "- Frontend code generated and committed",
                  "- UI spec respected strictly",
                  "- No persistence added"
                ].join("\n")
              });
            }

            await runFrontendAgent();

      - name: Update Issue Checklist
        if: success()
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            const issue_number = Number(process.env.ISSUE_NUMBER);
            const { owner, repo } = context.repo;

            try {
              // è·å– Issue å†…å®¹
              const { data: issue } = await github.rest.issues.get({
                owner,
                repo,
                issue_number
              });

              let body = issue.body || '';

              // æŸ¥æ‰¾å‰ç«¯ç›¸å…³çš„ checklist é¡¹å¹¶æ›´æ–°
              // åŒ¹é…æ¨¡å¼: åœ¨ "### å‰ç«¯" æˆ–ç±»ä¼¼æ ‡é¢˜ä¸‹çš„ [ ] é¡¹
              const frontendSectionRegex = /(###?\s*(?:å‰ç«¯|Frontend|FE)[^\n]*\n)([\s\S]*?)(?=\n###?\s|\n##?\s|$)/gi;

              body = body.replace(frontendSectionRegex, (match, header, content) => {
                // å°†è¯¥ section å†…çš„æ‰€æœ‰ [ ] æ›¿æ¢ä¸º [x]
                const updatedContent = content.replace(/\[\s*\]/g, '[x]');
                return header + updatedContent;
              });

              // æ›´æ–° Issue body
              await github.rest.issues.update({
                owner,
                repo,
                issue_number,
                body
              });

              console.log(`âœ… å·²æ›´æ–° Issue #${issue_number} çš„å‰ç«¯ checklist`);
            } catch (error) {
              console.error(`âš ï¸ æ›´æ–° checklist å¤±è´¥: ${error.message}`);
              // ä¸é˜»æ­¢ workflow å®Œæˆ
            }
