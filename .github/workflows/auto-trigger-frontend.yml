name: Auto Trigger Frontend After Backend Merge

on:
  pull_request:
    types: [closed]

jobs:
  trigger-frontend:
    # ä»…åœ¨ PR åˆå¹¶ï¼ˆéå…³é—­ï¼‰ä¸”æ˜¯åç«¯ Agent åˆ›å»ºçš„ PR æ—¶è§¦å‘
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.title, 'Backend:')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Extract Issue Number and Trigger Frontend
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const prBody = context.payload.pull_request.body || '';

            console.log("=".repeat(80));
            console.log("ğŸ”„ AUTO TRIGGER FRONTEND");
            console.log("=".repeat(80));
            console.log(`PR Title: ${prTitle}`);

            // ä» PR æ ‡é¢˜ä¸­æå– Issue ç¼–å·
            // æ ¼å¼: "Backend: xxx implementation (#123)"
            const issueMatch = prTitle.match(/#(\d+)/);
            if (!issueMatch) {
              console.log("âš ï¸ æœªæ‰¾åˆ°å…³è”çš„ Issue ç¼–å·ï¼Œè·³è¿‡");
              return;
            }

            const issueNumber = parseInt(issueMatch[1]);
            console.log(`ğŸ“‹ å…³è” Issue: #${issueNumber}`);

            // è·å– Issue ä¿¡æ¯
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // æ£€æŸ¥ Issue æ ‡é¢˜æˆ–å†…å®¹æ˜¯å¦åŒ…å«å‰ç«¯éœ€æ±‚
            const hasFrontendTask =
              issue.title.includes('[FE]') ||
              issue.title.includes('å‰ç«¯') ||
              issue.title.includes('Frontend') ||
              issue.body?.includes('### å‰ç«¯') ||
              issue.body?.includes('### Frontend') ||
              issue.body?.includes('## ğŸ–¥ å‰ç«¯') ||
              issue.body?.includes('## å‰ç«¯å®ç°');

            if (!hasFrontendTask) {
              console.log("âš ï¸ Issue ä¸åŒ…å«å‰ç«¯ä»»åŠ¡ï¼Œè·³è¿‡");

              // æ·»åŠ å®Œæˆè¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: [
                  "âœ… **åç«¯ PR å·²åˆå¹¶**",
                  "",
                  `ğŸ”— ${context.payload.pull_request.html_url}`,
                  "",
                  "æœªæ£€æµ‹åˆ°å‰ç«¯ä»»åŠ¡ï¼Œåç«¯å¼€å‘å®Œæˆï¼"
                ].join("\n")
              });
              return;
            }

            console.log("âœ… æ£€æµ‹åˆ°å‰ç«¯ä»»åŠ¡ï¼Œå‡†å¤‡è‡ªåŠ¨è§¦å‘");

            // åœ¨ Issue ä¸­æ·»åŠ è¯„è®ºè§¦å‘å‰ç«¯ Agent
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "âœ… **åç«¯ PR å·²åˆå¹¶**",
                "",
                `ğŸ”— ${context.payload.pull_request.html_url}`,
                "",
                "---",
                "",
                "ğŸ¤– **è‡ªåŠ¨è§¦å‘å‰ç«¯å¼€å‘...**",
                "",
                "/agent-fe",
                "",
                "> ğŸ’¡ åç«¯å¼€å‘å®Œæˆåè‡ªåŠ¨è§¦å‘å‰ç«¯ Agent"
              ].join("\n")
            });

            console.log(`âœ… å·²åœ¨ Issue #${issueNumber} ä¸­è§¦å‘å‰ç«¯ Agent`);
