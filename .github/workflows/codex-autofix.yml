name: Codex Auto-Fix on Failure

on:
  workflow_run:
    # Trigger this job after any run of the primary CI workflow completes
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    # Only run when the referenced workflow concluded with a failure
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      FAILED_WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
      FAILED_RUN_URL: ${{ github.event.workflow_run.html_url }}
      FAILED_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
      FAILED_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
    steps:
      - name: Check OpenAI API Key Set
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY secret is not set. Skipping auto-fix." >&2
            exit 1
          fi
      - name: Checkout Failing Ref
        uses: actions/checkout@v4
        with:
          ref: ${{ env.FAILED_HEAD_SHA }}
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm i; fi
      - name: Run Codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e

          # 创建 exec plan 文件
          cat > EXEC_PLAN.md <<'PLAN'
          # Auto-Fix Execution Plan
          
          ## Goal
          Fix failing CI tests with minimal surgical changes
          
          ## Status
          - [ ] Identify failing tests
          - [ ] Understand root cause
          - [ ] Implement minimal fix
          - [ ] Run tests → Fix → Run again (iterate)
          - [ ] Verify all tests pass
          
          ## Changes Made
          (Will be updated during execution)
          PLAN

          cat > CODEX_PROMPT.txt <<'PROMPT'
          You are fixing failing CI tests following Vibe Engineering principles.

          ## Your Task
          1. Run the test suite to identify failures
          2. Understand the root cause of each failure
          3. Implement the MINIMAL change needed to fix the tests
          4. Run tests → Fix failures → Run tests again (iterate until all pass)
          5. Update EXEC_PLAN.md with what you changed

          ## Watchdog Reminders
          - Goal: Make all tests pass with minimal changes
          - Do NOT refactor unrelated code
          - Do NOT change working code
          - Focus on: fixing the specific test failures only

          ## Vibe Engineering Principles
          - Code is cheap, trust is expensive
          - Spend time on tests: run → fix → run → fix (iterate)
          - Make minimal, surgical changes
          - Document what you changed and why

          Start by running tests, then fix failures iteratively.
          PROMPT

          # `-` 表示从 stdin 读取 prompt
          # 禁用 MCP 以避免连接等待（mcp startup: no servers）
          env CODEX_DISABLE_MCP="true" \
              MCP_DISABLED="true" \
              npx -y @openai/codex exec --full-auto -C . - < CODEX_PROMPT.txt
      - name: Verify tests
        run: npm test --silent
      - name: Create pull request with fixes
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "fix(ci): auto-fix failing tests via Codex"
          branch: codex/auto-fix-${{ github.event.workflow_run.run_id }}
          base: ${{ env.FAILED_HEAD_BRANCH }}
          title: "Auto-fix failing CI via Codex"
          body: |
            Codex automatically generated this PR in response to a CI failure following Vibe Engineering principles.
            
            ## Execution Plan
            $(if [ -f EXEC_PLAN.md ]; then cat EXEC_PLAN.md; else echo "Execution plan not available"; fi)
            
            ## Context
            - Failed workflow: `${{ env.FAILED_WORKFLOW_NAME }}`
            - Failed run: ${{ env.FAILED_RUN_URL }}
            - Head branch: `${{ env.FAILED_HEAD_BRANCH }}`
            
            ## Changes
            This PR contains minimal, surgical changes intended solely to make the CI pass.
            Following Vibe Engineering: code is cheap, trust is expensive - changes are focused on fixing test failures only.
