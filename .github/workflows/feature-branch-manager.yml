name: Feature Branch Manager

# åŠŸèƒ½åˆ†æ”¯ç®¡ç†å™¨
# 1. å½“ issue è¢«æ‰“ä¸Š `feature:xxx` label æ—¶ï¼Œè‡ªåŠ¨åˆ›å»º `feature/xxx` åˆ†æ”¯
# 2. æä¾› `/sync` å‘½ä»¤åŒæ­¥ main åˆ°åŠŸèƒ½åˆ†æ”¯
# 3. æä¾› `/merge-to-main` å‘½ä»¤åˆ›å»ºåˆå¹¶åˆ° main çš„ PR

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

jobs:
  # ============================================================
  # Job 1: è‡ªåŠ¨åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
  # è§¦å‘æ¡ä»¶ï¼šissue è¢«æ‰“ä¸Š `feature:xxx` label
  # ============================================================
  create-feature-branch:
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      startsWith(github.event.label.name, 'feature:')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Feature Branch
        uses: actions/github-script@v7
        with:
          script: |
            const label = context.payload.label.name;
            const issue = context.payload.issue;

            // ä» label æå–åˆ†æ”¯å: feature:insightflow -> feature/insightflow
            const branchName = label.replace(':', '/');

            console.log(`ğŸ“Œ åˆ›å»ºåŠŸèƒ½åˆ†æ”¯: ${branchName}`);
            console.log(`ğŸ“‹ å…³è” Issue: #${issue.number} - ${issue.title}`);

            // æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å·²å­˜åœ¨
            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName
              });

              console.log(`âš ï¸ åˆ†æ”¯å·²å­˜åœ¨: ${branchName}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âš ï¸ åŠŸèƒ½åˆ†æ”¯ \`${branchName}\` å·²å­˜åœ¨ã€‚\n\nå­ Issue çš„ PR å°†è‡ªåŠ¨åˆå¹¶åˆ°æ­¤åˆ†æ”¯ã€‚`
              });

              return;
            } catch (e) {
              if (e.status !== 404) throw e;
            }

            // è·å– main åˆ†æ”¯çš„æœ€æ–° commit SHA
            const { data: mainRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            // åˆ›å»ºæ–°åˆ†æ”¯
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: mainRef.object.sha
            });

            console.log(`âœ… åˆ†æ”¯åˆ›å»ºæˆåŠŸ: ${branchName}`);

            // åœ¨ issue ä¸Šå‘å¸ƒè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                `ğŸŒ¿ **åŠŸèƒ½åˆ†æ”¯å·²åˆ›å»º**: \`${branchName}\``,
                "",
                "## ä½¿ç”¨è¯´æ˜",
                "",
                "### å­ Issue PR è‡ªåŠ¨åˆå¹¶",
                `æ‰€æœ‰å¸¦æœ‰ \`${label}\` æ ‡ç­¾çš„å­ Issueï¼Œå…¶ PR å°†è‡ªåŠ¨åˆå¹¶åˆ° \`${branchName}\` åˆ†æ”¯ã€‚`,
                "",
                "### å¯ç”¨å‘½ä»¤",
                "| å‘½ä»¤ | è¯´æ˜ |",
                "|------|------|",
                `| \`/sync\` | å°† main åˆ†æ”¯æœ€æ–°ä»£ç åŒæ­¥åˆ° \`${branchName}\` |`,
                `| \`/merge-to-main\` | åˆ›å»º PR å°† \`${branchName}\` åˆå¹¶å› main |`,
                "",
                "### éƒ¨ç½²ç¯å¢ƒ",
                `- **Vercel**: å¯åœ¨ Dashboard å°† Preview ç¯å¢ƒæŒ‡å‘ \`${branchName}\``,
                `- **Railway**: å¯åœ¨ Dashboard åˆ‡æ¢ç¯å¢ƒåˆ†æ”¯åˆ° \`${branchName}\``,
                "",
                "---",
                `_åŸºäº main @ \`${mainRef.object.sha.substring(0, 7)}\` åˆ›å»º_`
              ].join("\n")
            });

  # ============================================================
  # Job 2: /sync å‘½ä»¤ - åŒæ­¥ main åˆ°åŠŸèƒ½åˆ†æ”¯
  # ============================================================
  sync-from-main:
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '/sync')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Check Feature Label
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            const featureLabel = labels.find(l => l.startsWith('feature:'));
            if (!featureLabel) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: "âŒ æ­¤ Issue æ²¡æœ‰ `feature:xxx` æ ‡ç­¾ï¼Œæ— æ³•æ‰§è¡Œ `/sync` å‘½ä»¤ã€‚"
              });
              core.setFailed("No feature label found");
              return;
            }

            const branchName = featureLabel.replace(':', '/');
            core.setOutput("branch", branchName);
            core.setOutput("label", featureLabel);

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.check.outputs.branch }}

      - name: Sync from Main
        id: sync
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="${{ steps.check.outputs.branch }}"

          echo "ğŸ”„ åŒæ­¥ main åˆ° $BRANCH..."

          git fetch origin main

          # å°è¯•åˆå¹¶ main
          if git merge origin/main --no-edit; then
            git push origin "$BRANCH"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… åŒæ­¥æˆåŠŸ"
          else
            git merge --abort
            echo "status=conflict" >> $GITHUB_OUTPUT
            echo "âŒ å­˜åœ¨å†²çª"
          fi

      - name: Report Result
        uses: actions/github-script@v7
        with:
          script: |
            const status = "${{ steps.sync.outputs.status }}";
            const branch = "${{ steps.check.outputs.branch }}";

            if (status === "success") {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âœ… **åŒæ­¥æˆåŠŸ**\n\n\`main\` åˆ†æ”¯å·²åˆå¹¶åˆ° \`${branch}\`ã€‚`
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: [
                  `âŒ **åŒæ­¥å¤±è´¥ - å­˜åœ¨å†²çª**`,
                  "",
                  `\`main\` åˆ†æ”¯ä¸ \`${branch}\` å­˜åœ¨å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚`,
                  "",
                  "```bash",
                  `git checkout ${branch}`,
                  "git fetch origin main",
                  "git merge origin/main",
                  "# è§£å†³å†²çªå",
                  "git add .",
                  "git commit",
                  `git push origin ${branch}`,
                  "```"
                ].join("\n")
              });
            }

  # ============================================================
  # Job 3: /merge-to-main å‘½ä»¤ - åˆ›å»ºåˆå¹¶åˆ° main çš„ PR
  # ============================================================
  merge-to-main:
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '/merge-to-main')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Check Feature Label
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            const featureLabel = labels.find(l => l.startsWith('feature:'));
            if (!featureLabel) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: "âŒ æ­¤ Issue æ²¡æœ‰ `feature:xxx` æ ‡ç­¾ï¼Œæ— æ³•æ‰§è¡Œ `/merge-to-main` å‘½ä»¤ã€‚"
              });
              core.setFailed("No feature label found");
              return;
            }

            const branchName = featureLabel.replace(':', '/');
            core.setOutput("branch", branchName);
            core.setOutput("label", featureLabel);
            core.setOutput("issue_number", issue.number);
            core.setOutput("issue_title", issue.title);

      - name: Create PR to Main
        uses: actions/github-script@v7
        with:
          script: |
            const branch = "${{ steps.check.outputs.branch }}";
            const issueNumber = ${{ steps.check.outputs.issue_number }};
            const issueTitle = `${{ steps.check.outputs.issue_title }}`;

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ PR
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              base: 'main',
              state: 'open'
            });

            if (existingPRs.length > 0) {
              const pr = existingPRs[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âš ï¸ å·²å­˜åœ¨åˆå¹¶åˆ° main çš„ PR: #${pr.number}\n\n${pr.html_url}`
              });
              return;
            }

            // åˆ›å»º PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš€ [Feature] ${issueTitle}`,
              head: branch,
              base: 'main',
              body: [
                `## åŠŸèƒ½åˆå¹¶`,
                "",
                `å…³è” Issue: #${issueNumber}`,
                "",
                `æ­¤ PR å°† \`${branch}\` åˆ†æ”¯çš„æ‰€æœ‰æ›´æ”¹åˆå¹¶åˆ° \`main\`ã€‚`,
                "",
                "### Checklist",
                "- [ ] æ‰€æœ‰å­ Issue å·²å®Œæˆ",
                "- [ ] ä»£ç å·²é€šè¿‡ review",
                "- [ ] æµ‹è¯•é€šè¿‡",
                "",
                "---",
                "_ç”± Feature Branch Manager è‡ªåŠ¨åˆ›å»º_"
              ].join("\n")
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `ğŸš€ **åˆå¹¶ PR å·²åˆ›å»º**: #${pr.number}`,
                "",
                pr.html_url,
                "",
                "åˆå¹¶æ­¤ PR åï¼š",
                "- Railway ç”Ÿäº§ç¯å¢ƒå°†è‡ªåŠ¨æ›´æ–°",
                "- Vercel ç”Ÿäº§ç¯å¢ƒå°†è‡ªåŠ¨æ›´æ–°"
              ].join("\n")
            });
