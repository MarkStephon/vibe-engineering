name: Agent Builder (Frontend Only)

on:
  issue_comment:
    types: [created]

jobs:
  builder:
    # è§¦å‘æŒ‡ä»¤ï¼š/code-zhangxiaohao-agent
    if: contains(github.event.comment.body, '/code-zhangxiaohao-agent')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Execute Frontend Implementation
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        with:
          script: |
            // 1. è·å–å†å²è¯„è®º (è¯»å–æ¶æ„å¸ˆçš„å‰ç«¯æ–¹æ¡ˆ)
            console.log("ğŸ“¥ æ­£åœ¨è¯»å–æ¶æ„å¸ˆæ–¹æ¡ˆ...");
            const comments = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.issue.number
            });
            
            const discussionHistory = comments.data
              .map(c => `[User: ${c.user.login}]:\n${c.body}`)
              .join("\n\n--- å†å²åˆ†å‰²çº¿ ---\n\n");

            // 2. è¯»å–çˆ¶çº§è§„èŒƒ (ä»…ä½œä¸ºä¸Šä¸‹æ–‡å‚è€ƒ)
            let contextBody = process.env.ISSUE_BODY;
            const parentRegex = /(?:Parent|Ref|çˆ¶ä»»åŠ¡|çˆ¶çº§|çˆ¶éœ€æ±‚|å…³è”çˆ¶éœ€æ±‚)[\s:ï¼š]+#(\d+)/i;
            const parentMatch = contextBody.match(parentRegex);
            
            if (parentMatch) {
               try {
                 const p = await github.rest.issues.get({ ...context.repo, issue_number: parentMatch[1] });
                 contextBody += `\n\n--- [çˆ¶çº§è§„èŒƒ] ---\n${p.data.body}`;
               } catch(e) {}
            }

            // 3. æ„å»º "çº¯å‰ç«¯" Prompt
            const prompt = `ä½ æ˜¯ä¸€å **çº¯ç²¹çš„å‰ç«¯å·¥ç¨‹å¸ˆ (Next.js Expert)**ã€‚
            ä½ çš„å·¥ä½œæ˜¯ï¼šåªçœ‹æ¶æ„å¸ˆæ–¹æ¡ˆä¸­çš„ **å‰ç«¯éƒ¨åˆ†**ï¼Œå¿½ç•¥ä¸€åˆ‡åç«¯/æ•°æ®åº“/DevOps å†…å®¹ã€‚
            
            ã€éœ€æ±‚æ¥æºã€‘
            æ ‡é¢˜ï¼š${process.env.ISSUE_TITLE}
            æè¿°ï¼š${contextBody}

            ã€æ¶æ„å¸ˆæ–¹æ¡ˆä¸è®¨è®ºã€‘
            ${discussionHistory}

            ã€ä½ çš„ä»»åŠ¡ã€‘
            ç¼–å†™å‰ç«¯ä»£ç æ–‡ä»¶ã€‚

            ã€ğŸ”¥ æ ¸å¿ƒè§„åˆ™ã€‘
            1. **åªåšå‰ç«¯**ï¼šåªç”Ÿæˆ .tsx, .ts, .css, .json (package.json) æ–‡ä»¶ã€‚çœ‹åˆ° .go, .sql, Dockerfile ç­‰åç«¯æ–‡ä»¶è¯·ç›´æ¥å¿½ç•¥ï¼Œä¸è¦ç”Ÿæˆã€‚
            2. **è·¯ç”±ç›®å½• (Next.js)**ï¼š
               - å¦‚æœéœ€è¦åˆ›å»ºæ–°é¡µé¢ï¼Œ**å¿…é¡»**åˆ›å»ºåŒ…å«è·¯ç”±çš„ç›®å½•ç»“æ„ï¼ˆå¦‚ \`frontend/app/notes/[id]/page.tsx\`ï¼‰ã€‚
               - ä¸¥ç¦æŠŠé¡µé¢é€»è¾‘å†™åœ¨ components é‡Œè€Œä¸åˆ›å»º page.tsxã€‚
            3. **å¤ç”¨**ï¼šå¦‚æœçˆ¶çº§è§„èŒƒæˆ–æ¶æ„æ–¹æ¡ˆé‡Œæåˆ°äº†ç°æœ‰çš„ API è·¯å¾„ï¼ˆå¦‚ /api/v1/userï¼‰ï¼Œè¯·ç›´æ¥åœ¨ fetch ä¸­ä½¿ç”¨è¯¥è·¯å¾„ï¼Œä½†ä¸è¦å»å®ç°è¿™ä¸ª APIã€‚

            ã€è¾“å‡ºæ ¼å¼ã€‘
            âŒ ä¸è¦è¿”å› JSONã€‚
            âœ… è¯·ä½¿ç”¨åˆ†éš”ç¬¦æ ¼å¼ï¼š

            ### FILE: frontend/app/login/page.tsx
            \`\`\`typescript
            (ä»£ç ...)
            \`\`\`

            ### FILE: frontend/components/ui/button.tsx
            \`\`\`typescript
            (ä»£ç ...)
            \`\`\`

            ã€çº¦æŸã€‘
            1. äº¤äº’ç»„ä»¶é¦–è¡Œå¿…é¡»æ˜¯ "use client";
            2. ä½¿ç”¨ Tailwind CSSã€‚
            `;

            console.log("ğŸ¤– æ­£åœ¨ç¼–å†™å‰ç«¯ä»£ç  (OpenRouter AI)...");

            // 4. è°ƒç”¨ AI
            const aiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-3.5-sonnet",
                messages: [{ role: "user", content: prompt }]
              })
            });
            
            if (!aiRes.ok) throw new Error(`AI API Error: ${await aiRes.text()}`);
            const aiData = await aiRes.json();
            const rawContent = aiData.choices[0].message.content;

            // 5. è§£æåˆ†éš”ç¬¦æ ¼å¼
            console.log("ğŸ“¦ è§£ææ–‡ä»¶...");
            const files = [];
            const lines = rawContent.split('\n');
            let currentFile = null;
            let currentContentLines = [];

            for (const line of lines) {
              if (line.trim().startsWith('### FILE:')) {
                if (currentFile) {
                  files.push({ 
                    path: currentFile, 
                    content: currentContentLines.join('\n').replace(/^```[a-z]*\n?/i, '').replace(/\n?```$/, '').trim() 
                  });
                }
                currentFile = line.replace('### FILE:', '').trim();
                currentContentLines = [];
              } else {
                if (currentFile) {
                  currentContentLines.push(line);
                }
              }
            }
            if (currentFile) {
              files.push({ 
                path: currentFile, 
                content: currentContentLines.join('\n').replace(/^```[a-z]*\n?/i, '').replace(/\n?```$/, '').trim() 
              });
            }

            if (files.length === 0) {
              console.log("åŸå§‹å†…å®¹:", rawContent);
              throw new Error("AI æœªç”Ÿæˆä»»ä½•æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯å› ä¸ºPromptè¿‡æ»¤å¤ªä¸¥æˆ–æ ¼å¼é”™è¯¯");
            }

            // 6. Git æäº¤ (ä½¿ç”¨ zhangxiaohao åˆ†æ”¯å)
            const branchName = `zhangxiaohao/issue-${context.issue.number}`;
            const baseRef = await github.rest.git.getRef({ ...context.repo, ref: 'heads/main' });
            
            try {
                await github.rest.git.createRef({ 
                    ...context.repo, 
                    ref: `refs/heads/${branchName}`, 
                    sha: baseRef.data.object.sha 
                });
            } catch (e) {
                console.log("â„¹ï¸ åˆ†æ”¯å·²å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°...");
            }

            for (const file of files) {
              // äºŒæ¬¡ä¿é™©ï¼šå¦‚æœ AI è¿˜æ˜¯å‘ç–¯ç”Ÿæˆäº† .go æ–‡ä»¶ï¼Œå‰ç«¯ Agent æ‹’ç»å†™å…¥
              if (file.path.endsWith('.go') || file.path.includes('backend/')) {
                  console.log(`âš ï¸ è·³è¿‡åç«¯æ–‡ä»¶: ${file.path} (æˆ‘æ˜¯å‰ç«¯ Agent)`);
                  continue;
              }

              console.log(`ğŸ“ å†™å…¥å‰ç«¯æ–‡ä»¶: ${file.path}`);
              let sha;
              try {
                const { data } = await github.rest.repos.getContent({ 
                    ...context.repo, 
                    path: file.path, 
                    ref: branchName 
                });
                sha = data.sha;
              } catch (e) {} 

              await github.rest.repos.createOrUpdateFileContents({
                ...context.repo,
                path: file.path,
                message: `feat(fe): ${file.path}`,
                content: Buffer.from(file.content).toString('base64'),
                branch: branchName,
                sha: sha
              });
            }

            try {
              const pr = await github.rest.pulls.create({
                ...context.repo,
                title: `âœ¨ [Frontend] ${process.env.ISSUE_TITLE}`,
                head: branchName,
                base: 'main',
                body: `ğŸ¤– **å‰ç«¯ä»£ç å·²å°±ç»ª**\n\næŒ‡ä»¤: \`/code-zhangxiaohao-agent\`\nåªåŒ…å«å‰ç«¯å®ç°ï¼Œåç«¯é€»è¾‘å·²è‡ªåŠ¨è¿‡æ»¤ã€‚\n\n### æ–‡ä»¶åˆ—è¡¨ï¼š\n${files.map(f => `- \`${f.path}\``).join('\n')}`
              });
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âœ… **å‰ç«¯ä»£ç ç”Ÿæˆå®Œæ¯•ï¼**\nPR: ${pr.data.html_url}`
              });
            } catch (e) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âœ… **ä»£ç å·²æ›´æ–°åˆ°ç°æœ‰åˆ†æ”¯ï¼**`
              });
            }